<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=1024, user-scalable=no">

	<title>Puppet Tutorial</title>
	
	<!-- Required stylesheet -->
	<link rel="stylesheet" href="core/deck.core.css">
	
	<!-- Extension CSS files go here. Remove or add as needed. -->	
	<link rel="stylesheet" href="extensions/goto/deck.goto.css">
	<link rel="stylesheet" href="extensions/menu/deck.menu.css">
	<link rel="stylesheet" href="extensions/navigation/deck.navigation.css">
	<link rel="stylesheet" href="extensions/status/deck.status.css">
	<link rel="stylesheet" href="extensions/hash/deck.hash.css">
	<link rel="stylesheet" href="extensions/scale/deck.scale.css">
	<link rel="stylesheet" href="extensions/title/deck.title.css">	
	<link rel="stylesheet" href="extensions/highlight/deck.highlight.css">	

	

	<!-- Style theme. More available in /themes/style/ or create your own. -->
	<link rel="stylesheet" href="themes/style/swiss.css">
	
	<!-- Transition theme. More available in /themes/transition/ or create your own. -->
	<link rel="stylesheet" href="themes/transition/horizontal-slide.css">
	
	<!-- Required Modernizr file -->
	<script src="modernizr.custom.js"></script>
	
</head>
<body class="deck-container">

<!-- Begin slides. Just make elements with a class of slide. -->


  <!-- First slide -->  
  <section class="slide">
     <header>Puppet Tutorial</header>
        
     <address class="author">By Alessandro Franceschi</address>
     
     
     <address class="company">Example42</address>
          
     <address><time>11-07-2015</time></address>
  </section>
  


  <section class="slide">
     
     
           
       
         <h2>Puppet Essentials - Overview</h2>
       
                            
     <h3>Introduction to <abbr title="Puppet automation tool">Puppet</abbr></h3> 
<h3>Configuration management tools</h3> 
<h3><abbr title="Puppet automation tool">Puppet</abbr> Ecosystem and related software</h3>
  </section>

  <section class="slide">
     
     
           
       
         <h2>What is Puppet</h2>
       
                            
     <p>A <strong>Configuration Management</strong> Tool</p>
<p>A framework for <strong>Systems Automation</strong></p>
<p>A Declarative Domain Specific Language (<strong><abbr title="Domain Specific Langauge">DSL</abbr></strong>)</p>
<p>An <strong>OpenSource software</strong> in written Ruby</p>
<p>Works on Linux, Unix (Solaris, AIX, *BSD), MacOS, Windows (<a href="http://docs.puppetlabs.com/guides/platforms.html">Supported Platforms</a>)</p>
<p>Developed by <strong><a href="http://puppetlabs.com"><abbr title="Puppet automation tool">Puppet</abbr> Labs</a></strong></p>
<p>Used by <a href="http://puppetlabs.com/customers/companies/">http://puppetlabs.com/customers/companies/</a> ...</p>
<p>... and <strong>many</strong> others</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Configuration Management advantages</h2>
       
                            
     <p><strong>Infrastructure as Code</strong>: Track, Test, Deploy, Reproduce, Scale</p>
<p>Code commits log shows the <strong>history of change</strong> on the infrastructure</p>
<p><strong>Reproducible setups</strong>: Do once, repeat forever</p>
<p><strong>Scale</strong> quickly: Done for one, use on many</p>
<p><strong>Coherent</strong> and consistent server setups</p>
<p><strong>Aligned Environments</strong> for devel, test, qa, prod nodes</p>
<p>Alternatives to <abbr title="Puppet automation tool">Puppet</abbr>: <a href="http://www.opscode.com/chef/">Chef</a>, <a href="http://cfengine.com/">CFEngine</a>, <a href="http://saltstack.com/">Salt</a>, <a href="http://www.ansibleworks.com/">Ansible</a></p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>References and Ecosystem</h2>
       
                            
     <p><a href="http://puppetlabs.com"><abbr title="Puppet automation tool">Puppet</abbr> Labs</a> - The Company behind <abbr title="Puppet automation tool">Puppet</abbr></p>
<p><a href="http://puppetlabs.com/puppet/puppet-open-source/"><abbr title="Puppet automation tool">Puppet</abbr></a> - The OpenSource version</p>
<p><a href="http://puppetlabs.com/puppet/puppet-enterprise/"><abbr title="Puppet automation tool">Puppet</abbr> Enterprise</a> - The commercial version</p>
<p><a href="http://puppetlabs.com/community/overview/">The Community</a> - Active and vibrant</p>
<p><a href="http://docs.puppetlabs.com/"><abbr title="Puppet automation tool">Puppet</abbr> Documentation</a> - Main and Official reference</p>
<p><abbr title="Puppet automation tool">Puppet</abbr> Modules on: <a href="http://forge.puppetlabs.com">Module Forge</a> and <a href="https://github.com/search?q=puppet">GitHub</a></p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Software related to Puppet:</h2>
       
                            
     <p><a href="http://docs.puppetlabs.com/facter/">Facter</a> - Complementary tool to retrieve system's data</p>
<p><a href="http://docs.puppetlabs.com/mcollective/">MCollective</a> - Infrastructure Orchestration framework</p>
<p><a href="http://docs.puppetlabs.com/hiera/1/">Hiera</a> - Key-value lookup tool where <abbr title="Puppet automation tool">Puppet</abbr> data can be placed</p>
<p><a href="http://docs.puppetlabs.com/puppetdb/1/">PuppetDB</a> - Stores all the data generated by <abbr title="Puppet automation tool">Puppet</abbr></p>
<p><a href="http://docs.puppetlabs.com/dashboard/"><abbr title="Puppet automation tool">Puppet</abbr> DashBoard</a> - A <abbr title="Puppet automation tool">Puppet</abbr> <em>Web frontend</em> and External Node Classifier (ENC)</p>
<p><a href="http://theforeman.org/">The Foreman</a> - A well-known third party provisioning tool and <abbr title="Puppet automation tool">Puppet</abbr> ENC</p>
<p><a href="http://cloudsmith.github.com/geppetto">Geppetto</a> - A <abbr title="Puppet automation tool">Puppet</abbr> IDE based on Eclipse</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Installation</h2>
       
                            
     <p>Debian, Ubuntu<br /> Available by default</p> 
<pre class=" code"><code><span class="java_plain">apt</span><span class="java_operator">-</span><span class="java_plain">get&nbsp;install&nbsp;puppet&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;</span><span class="java_type">On</span><span class="java_plain">&nbsp;clients&nbsp;</span><span class="java_separator">(</span><span class="java_plain">nodes</span><span class="java_separator">)</span><span class="java_plain"></span>
<span class="java_plain">apt</span><span class="java_operator">-</span><span class="java_plain">get&nbsp;install&nbsp;puppetmaster&nbsp;#&nbsp;</span><span class="java_type">On</span><span class="java_plain">&nbsp;server&nbsp;</span><span class="java_separator">(</span><span class="java_plain">master</span><span class="java_separator">)</span><span class="java_plain"></span></code></pre>
<p>RedHat, Centos, Fedora<br /> Add EPEL repository or RHN Extra channel</p> 
<pre class=" code"><code><span class="java_plain">yum&nbsp;install&nbsp;puppet&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;</span><span class="java_type">On</span><span class="java_plain">&nbsp;clients&nbsp;</span><span class="java_separator">(</span><span class="java_plain">nodes</span><span class="java_separator">)</span><span class="java_plain"></span>
<span class="java_plain">yum&nbsp;install&nbsp;puppet</span><span class="java_operator">-</span><span class="java_plain">server&nbsp;#&nbsp;</span><span class="java_type">On</span><span class="java_plain">&nbsp;server&nbsp;</span><span class="java_separator">(</span><span class="java_plain">master</span><span class="java_separator">)</span><span class="java_plain"></span></code></pre>
<p>Use <a href="http://docs.puppetlabs.com/guides/puppetlabs_package_repositories.html">PuppetLabs repositories</a> for latest updates</p>
<p><a href="http://docs.puppetlabs.com/guides/installation.html">Installation Instructions</a> for different OS</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Puppet Versions</h2>
       
                            
     <p>From version 2 <abbr title="Puppet automation tool">Puppet</abbr> follows <a href="http://semver.org/">Semantic Versioning</a> standards to manage versioning, with a pattern like: MAJOR.MINOR.PATCH</p>
<p>This implies that MAYOR versions might not be backwards compatible, MINOR versions may introduce new features keeping compatibility and PATCHes are for backwards compatible bug fixes.</p>
<p>This is the history of the main <abbr title="Puppet automation tool">Puppet</abbr> versions and some relevant changes<br />Check also <a href="http://docs.puppetlabs.com/guides/language_history.html"><abbr title="Puppet automation tool">Puppet</abbr> Language History</a> for a more complete review:</p>
<p>0.9.x - First public beta</p>
<p>0.10.x - 0.21.x - Various &quot;early&quot; versions</p>
<p>0.22.x - 0.25.x - Improvements and OS wider support</p>
<p>2.6.x - Many changes. Parametrized classes</p>
<p>2.7.x - Windows support</p>
<p>3.0.x - Many changes. Disabled dynamic variables scope. Data bindings</p>
<p>3.2.x - Future parser (experimental, will be default in <abbr title="Puppet automation tool">Puppet</abbr> 4)</p>
<p>4.x.x - Release in early 2015. New parser, new type system and lot of changes, some backwards incompatibilities</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Language Basics - Overview</h2>
       
                            
     <h3>Introduction to <abbr title="Puppet automation tool">Puppet</abbr> language and terms</h3> 
<h3>Resource types</h3> 
<h3>Classes and defines</h3> 
<h3>&nbsp;Variables and parameters</h3> 
<h3>&nbsp;Nodes classification</h3>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Puppet Language</h2>
       
                            
     <p>A <strong>Declarative</strong> Domain Specific Language (<abbr title="Domain Specific Langauge">DSL</abbr>)</p>
<p>It defines <strong>STATES</strong> (Not procedures)</p>
<p><abbr title="Puppet automation tool">Puppet</abbr> code is written in <strong>manifests</strong> (files with <strong>.pp</strong> extension)</p>
<p>In the code we declare <strong>resources</strong> that affect elements of the system (files, packages, services ...)</p>
<p>Resources are grouped in <strong>classes</strong> which may expose parameters that affect their behavior.</p>
<p>Classes and configuration files are organized in <strong>modules</strong>.</p>
<p>Consult the <strong><a href="https://docs.puppetlabs.com/references/glossary.html">official glossary</a></strong> to give the correct meaning to <abbr title="Puppet automation tool">Puppet</abbr> terms</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Nodes classification</h2>
       
                            
     <p>When clients connect, the <abbr title="Puppet automation tool">Puppet</abbr> Master generates a <strong>catalog</strong> with the list of of the resources that clients have to apply locally.</p>
<p>The <abbr title="Puppet automation tool">Puppet</abbr> Master has to <em>classify</em> nodes and define for each of them:</p>
<p>The <strong>classes</strong> to include<br /> The <strong>parameters</strong> to pass<br /> The <abbr title="Puppet automation tool">Puppet</abbr> <strong>environment</strong> to use</p>
<p>The <strong>catalog</strong> is generated by the Master according to the logic of our <abbr title="Puppet automation tool">Puppet</abbr> code and data.</p>
<p>In our code we can define our <strong>variables</strong> and use other ones that may come from different sources:</p>
<p><strong>facts</strong> generated directly by the client<br /> <strong>parameters</strong> obtained from node's classification<br /> <abbr title="Puppet automation tool">Puppet</abbr> <strong>internal</strong> variables</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Resource Types (Types)</h2>
       
                            
     <p>Resource Types are single <strong>units of configuration</strong> composed by:</p>
<p>A <strong>type</strong> (package, service, file, user, mount, exec ...)</p>
<p>A <strong>title</strong> (how is called and referred)</p>
<p>Zero or more <strong>arguments</strong></p> 
<pre class=" code"><code><span class="java_plain">type&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">'title'</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;argument&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;value</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;other_arg&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;value</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span></code></pre>
<p>Example for a <strong>file</strong> resource type:</p> 
<pre class=" code"><code><span class="java_plain">file&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">'motd'</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;path&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'/etc/motd'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;content&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'Tomorrow&nbsp;is&nbsp;another&nbsp;day'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Resource Types reference</h2>
       
                            
     <p>Find online the complete <a href="http://docs.puppetlabs.com/references/latest/type.html">Type Reference</a> for the latest or earlier versions.</p>
<p>From the shell the command line interface:</p> 
<pre class=" code"><code><span class="java_plain">puppet&nbsp;describe&nbsp;file</span></code></pre>
<p>For the full list of available descriptions try:</p> 
<pre class=" code"><code><span class="java_plain">puppet&nbsp;describe&nbsp;</span><span class="java_operator">--</span><span class="java_plain">list</span></code></pre>
<p>Give a glance to <abbr title="Puppet automation tool">Puppet</abbr> code for the list of <strong>native</strong> resource types:</p> 
<pre class=" code"><code><span class="java_plain">ls&nbsp;$</span><span class="java_separator">(</span><span class="java_plain">facter&nbsp;rubysitedir</span><span class="java_separator">)</span><span class="java_operator">/</span><span class="java_plain">puppet</span><span class="java_operator">/</span><span class="java_plain">type</span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Simple samples of resources</h2>
       
                            
     <p>Installation of OpenSSH package</p> 
<pre class=" code"><code><span class="java_keyword">package</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">'openssh'</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;ensure&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;present</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span></code></pre>
<p>Creation of /etc/motd file</p> 
<pre class=" code"><code><span class="java_plain">file&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">'motd'</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;path&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'/etc/motd'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span></code></pre>
<p>Start of httpd service</p> 
<pre class=" code"><code><span class="java_plain">service&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">'httpd'</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;ensure&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;running</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;enable&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">true</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>More complex samples of resources</h2>
       
                            
     <p>Management of nginx service with parameters defined in module's variables</p> 
<pre class=" code"><code><span class="java_plain">service&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">'nginx'</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;ensure&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;$</span><span class="java_operator">::</span><span class="java_plain">nginx</span><span class="java_operator">::</span><span class="java_plain">manage_service_ensure</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;$</span><span class="java_operator">::</span><span class="java_plain">nginx</span><span class="java_operator">::</span><span class="java_plain">service_name</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;enable&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;$</span><span class="java_operator">::</span><span class="java_plain">nginx</span><span class="java_operator">::</span><span class="java_plain">manage_service_enable</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span></code></pre>
<p>Creation of nginx.conf with content retrieved from different sources (first found is served)</p> 
<pre class=" code"><code><span class="java_plain">file&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">'nginx.conf'</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;ensure&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;present</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;path&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'/etc/nginx/nginx.conf'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;source&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_separator">[</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">&quot;puppet:///modules/site/nginx.conf--${::fqdn}&quot;</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">&quot;puppet:///modules/site/nginx.conf&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">],</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Resource Abstraction Layer</h2>
       
                            
     <p>Resources are abstracted from the underlying OS</p>
<p>Resource <strong>types</strong> have different providers for different OS</p>
<p>The <code><span class="java_keyword">package</span><span class="java_plain"></span></code> type is known for the great number of <strong>providers</strong></p> 
<pre class=" code"><code><span class="java_plain">ls&nbsp;$</span><span class="java_separator">(</span><span class="java_plain">facter&nbsp;rubysitedir</span><span class="java_separator">)</span><span class="java_operator">/</span><span class="java_plain">puppet</span><span class="java_operator">/</span><span class="java_plain">provider</span><span class="java_operator">/</span><span class="java_keyword">package</span><span class="java_plain"></span></code></pre>
<p>Use <strong>puppet resource</strong> to interrogate the RAL:</p> 
<pre class=" code"><code><span class="java_plain">puppet&nbsp;resource&nbsp;user</span>
<span class="java_plain"></span>
<span class="java_plain">puppet&nbsp;resource&nbsp;user&nbsp;root</span>
<span class="java_plain"></span>
<span class="java_plain">puppet&nbsp;resource&nbsp;</span><span class="java_keyword">package</span><span class="java_plain"></span>
<span class="java_plain"></span>
<span class="java_plain">puppet&nbsp;resource&nbsp;service</span></code></pre>
<p>Or to directly modify resources:</p> 
<pre class=" code"><code><span class="java_plain">puppet&nbsp;resource&nbsp;service&nbsp;httpd&nbsp;ensure</span><span class="java_operator">=</span><span class="java_plain">running&nbsp;enable</span><span class="java_operator">=</span><span class="java_literal">true</span><span class="java_plain"></span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Classes - Definition</h2>
       
                            
     <p>Classes are <strong>containers</strong> of different resources. Since <abbr title="Puppet automation tool">Puppet</abbr> 2.6 they can have parameters</p>
<p>Example of a class <strong>definition</strong>:</p> 
<pre class=" code"><code><span class="java_keyword">class</span><span class="java_plain">&nbsp;mysql&nbsp;</span><span class="java_separator">(</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;root_password&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'default_value'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;port&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'3306'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">package</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">'mysql-server'</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;ensure&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;present</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;service&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">'mysql'</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;ensure&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;running</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">[...]</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span></code></pre>
<p>Note that when we define a class we just describe what it does and what parameters it has, we don't actually add it and its resources to the catalog.</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Classes - Declaration</h2>
       
                            
     <p>When we have to use a class previously defined, we <strong>declare</strong> it.</p>
<p>This can be done in 2 different ways:</p>
<p>&quot;Old style&quot; class declaration, without parameters:</p> 
<pre class=" code"><code><span class="java_plain">include&nbsp;mysql</span></code></pre>
<p>(Inside a catalog we can have multiple includes of the same class but that class it's applied only once.)</p>
<p>&quot;New style&quot; (from <abbr title="Puppet automation tool">Puppet</abbr> 2.6) class declaration with explicit parameters:</p> 
<pre class=" code"><code><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">'mysql'</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;root_password&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'my_value'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;port&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'3307'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span></code></pre>
<p>(Syntax is the same of normal resources and the same class can be declared, in this way, only once inside the same catalog)</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Defines</h2>
       
                            
     <p>Also called: <strong>Defined resource types</strong> or <strong>defined types</strong></p>
<p>Similar to parametrized classes but can be used multiple times (with different titles).</p>
<p><strong>Definition</strong> of a define:</p> 
<pre class=" code"><code><span class="java_plain">define&nbsp;apache</span><span class="java_operator">::</span><span class="java_plain">virtualhost&nbsp;</span><span class="java_separator">(</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;$ensure&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;present</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;$template&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">'apache/virtualhost.conf.erb'</span><span class="java_plain">&nbsp;</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">[...]</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain"></span>
<span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;file&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;ApacheVirtualHost_${name}&quot;</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;ensure&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;$ensure</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;content&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;template</span><span class="java_separator">(</span><span class="java_literal">&quot;${template}&quot;</span><span class="java_separator">),</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span></code></pre>
<p><strong>Declaration</strong> of a define:</p> 
<pre class=" code"><code><span class="java_plain">apache</span><span class="java_operator">::</span><span class="java_plain">virtualhost&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">'www.example42.com'</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;template&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'site/apache/www.example42.com-erb'</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Variables</h2>
       
                            
     <p>We need them to provide different configurations for different kind of servers.</p>
<p>They can be defined in different places and by different actors:</p>
<p>Can be provided by client nodes as <strong>facts</strong></p>
<p>Can be <strong>defined by users</strong> in <abbr title="Puppet automation tool">Puppet</abbr> code, on Hiera on in the ENC</p>
<p>Can be <strong>built-in</strong> and be provided directly by <abbr title="Puppet automation tool">Puppet</abbr></p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Facts</h2>
       
                            
     <p><strong>Facter</strong> runs on clients and collects <strong>facts</strong> that the server can use as variables</p> 
<pre class=" code"><code><span class="java_plain">al$&nbsp;facter</span>
<span class="java_plain"></span>
<span class="java_plain">architecture&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;x86_64</span>
<span class="java_plain">fqdn&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_type">Macante</span><span class="java_separator">.</span><span class="java_plain">example42</span><span class="java_separator">.</span><span class="java_plain">com</span>
<span class="java_plain">hostname&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_type">Macante</span><span class="java_plain"></span>
<span class="java_plain">interfaces&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;lo0</span><span class="java_separator">,</span><span class="java_plain">eth0</span>
<span class="java_plain">ipaddress&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">10.42.42.98</span><span class="java_plain"></span>
<span class="java_plain">ipaddress_eth0&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">10.42.42.98</span><span class="java_plain"></span>
<span class="java_plain">kernel&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_type">Linux</span><span class="java_plain"></span>
<span class="java_plain">macaddress&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">20</span><span class="java_operator">:</span><span class="java_plain">c9</span><span class="java_operator">:</span><span class="java_plain">d0</span><span class="java_operator">:</span><span class="java_literal">44</span><span class="java_operator">:</span><span class="java_literal">61</span><span class="java_operator">:</span><span class="java_literal">57</span><span class="java_plain"></span>
<span class="java_plain">macaddress_eth0&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">20</span><span class="java_operator">:</span><span class="java_plain">c9</span><span class="java_operator">:</span><span class="java_plain">d0</span><span class="java_operator">:</span><span class="java_literal">44</span><span class="java_operator">:</span><span class="java_literal">61</span><span class="java_operator">:</span><span class="java_literal">57</span><span class="java_plain"></span>
<span class="java_plain">memorytotal&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">16.00</span><span class="java_plain">&nbsp;GB</span>
<span class="java_plain">netmask&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">255.255.255.0</span><span class="java_plain"></span>
<span class="java_plain">operatingsystem&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_type">Centos</span><span class="java_plain"></span>
<span class="java_plain">operatingsystemrelease&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">6.3</span><span class="java_plain"></span>
<span class="java_plain">osfamily&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_type">RedHat</span><span class="java_plain"></span>
<span class="java_plain">virtual&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;physical</span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>User Variables</h2>
       
                            
     <p>We can define custom variables in different ways:</p> 
<h4>In <abbr title="Puppet automation tool">Puppet</abbr> <strong>manifests</strong>:</h4> 
<pre class=" code"><code><span class="java_plain">$role&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">'mail'</span><span class="java_plain"></span>
<span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;$package&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;$</span><span class="java_operator">::</span><span class="java_plain">operatingsystem&nbsp;</span><span class="java_operator">?</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">/</span><span class="java_separator">(</span><span class="java_operator">?</span><span class="java_plain">i</span><span class="java_operator">:</span><span class="java_type">Ubuntu</span><span class="java_operator">|</span><span class="java_type">Debian</span><span class="java_operator">|</span><span class="java_type">Mint</span><span class="java_separator">)</span><span class="java_operator">/</span><span class="java_plain">&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'apache2'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">default</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'httpd'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span><span class="java_plain"></span></code></pre> 
<h4>In an <strong>External Node Classifier</strong> (ENC)</h4>
<p>Commonly used ENC are <abbr title="Puppet automation tool">Puppet</abbr> DashBoard, the Foreman, <abbr title="Puppet automation tool">Puppet</abbr> Enterprise.</p> 
<h4>In an <strong>Hiera</strong> backend</h4> 
<pre class=" code"><code><span class="java_plain">$syslog_server&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;hiera</span><span class="java_separator">(</span><span class="java_plain">syslog_server</span><span class="java_separator">)</span><span class="java_plain"></span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Built-in variables</h2>
       
                            
     <p><abbr title="Puppet automation tool">Puppet</abbr> provides some useful built in variables, they can be:</p> 
<h4>Set by the client (agent)</h4>
<p><code><span class="java_plain">$clientcert</span></code> - the name of the node's certificate. By default its <code><span class="java_plain">$</span><span class="java_operator">::</span><span class="java_plain">fqdn</span></code><br /><code><span class="java_plain">$clientversion</span></code> - the <abbr title="Puppet automation tool">Puppet</abbr> version on the client</p> 
<h4>Set by the server (master)</h4>
<p><code><span class="java_plain">$environment</span></code> (default: production) - the <abbr title="Puppet automation tool">Puppet</abbr> environment where are placed modules and manifests.<br /><code><span class="java_plain">$servername</span></code>, <code><span class="java_plain">$serverip</span></code> - the <abbr title="Puppet automation tool">Puppet</abbr> Master FQDN and IP<br /><code><span class="java_plain">$serverversion</span></code> - the <abbr title="Puppet automation tool">Puppet</abbr> version on the server<br /><code><span class="java_plain">$settings</span><span class="java_operator">::&lt;</span><span class="java_plain">name</span><span class="java_operator">&gt;</span><span class="java_plain"></span></code> - any configuration setting on the Master's <code><span class="java_plain">puppet</span><span class="java_separator">.</span><span class="java_plain">conf</span></code></p> 
<h4>Set by the server during catalog compilation</h4>
<p><code><span class="java_plain">$module_name</span></code> - the name of the module that contains the current resource's definition<br /><code><span class="java_plain">$caller_module_name</span></code> - the name of the module that contains the current resource's declaration</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Environments</h2>
       
                            
     <p><abbr title="Puppet automation tool">Puppet</abbr> environments allow isolation of <abbr title="Puppet automation tool">Puppet</abbr> code and data: for each environment we can have different paths manifest files, Hiera data and modules.</p>
<p><abbr title="Puppet automation tool">Puppet</abbr>'s environments DO NOT necessarily have to match the operational environments of our servers.</p>
<p>Environments mamanagement has changed from <abbr title="Puppet automation tool">Puppet</abbr> 3.6 onwards:</p>
<p>Earlier versions were based on so-called <strong>Config file Environments</strong> where each environment had to be defined in <strong>puppet.conf</strong>.</p>
<p>From 3.6 <strong>directory environments</strong> have been introduced and the older approach has been deprecated.</p>
<p>On <abbr title="Puppet automation tool">Puppet</abbr> 4.x only directory environments are supported.</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Config file Environments</h2>
       
                            
     <p>The &quot;old&quot; config file environments are defined inside <code><span class="java_plain">puppet</span><span class="java_separator">.</span><span class="java_plain">conf</span></code>&nbsp;with a syntax like:</p> 
<pre class=" code"><code><span class="java_separator">[</span><span class="java_plain">test</span><span class="java_separator">]</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;modulepath&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;$confdir</span><span class="java_operator">/</span><span class="java_plain">environments</span><span class="java_operator">/</span><span class="java_plain">test</span><span class="java_operator">/</span><span class="java_plain">modules</span><span class="java_operator">:</span><span class="java_plain">$condfir</span><span class="java_operator">/</span><span class="java_plain">modules</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;manifest&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;$confdir</span><span class="java_operator">/</span><span class="java_plain">environments</span><span class="java_operator">/</span><span class="java_plain">test</span><span class="java_operator">/</span><span class="java_plain">manifests</span></code></pre>
<p>For the default <strong>production</strong> environment there were the config parameters, now deprecated, <code><span class="java_plain">manifest</span></code> and <code><span class="java_plain">modulepath</span></code> in the <code><span class="java_separator">[</span><span class="java_plain">main</span><span class="java_separator">]</span><span class="java_plain"></span></code> section.</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Directory Environments</h2>
       
                            
     <p>Directory Environments are configured in <code><span class="java_plain">puppet</span><span class="java_separator">.</span><span class="java_plain">conf</span></code> as follows:</p> 
<pre class=" code"><code><span class="java_separator">[</span><span class="java_plain">main</span><span class="java_separator">]</span><span class="java_plain"></span>
<span class="java_plain">environmentpath&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;$configdir</span><span class="java_operator">/</span><span class="java_plain"></span></code></pre>
<p>Then inside the <code><span class="java_operator">/</span><span class="java_plain">etc</span><span class="java_operator">/</span><span class="java_plain">puppet</span><span class="java_operator">/</span><span class="java_plain">environments</span><span class="java_operator">/</span><span class="java_plain">$environment</span><span class="java_operator">/</span><span class="java_plain"></span></code> directory we have:</p> 
<pre class=" code"><code><span class="java_plain">modules</span><span class="java_operator">/</span><span class="java_plain">&nbsp;&nbsp;&nbsp;#&nbsp;</span><span class="java_type">Directory</span><span class="java_plain">&nbsp;containing&nbsp;modules</span>
<span class="java_plain">manifests</span><span class="java_operator">/</span><span class="java_plain">&nbsp;#&nbsp;</span><span class="java_type">Directory</span><span class="java_plain">&nbsp;containing&nbsp;site</span><span class="java_separator">.</span><span class="java_plain">pp</span>
<span class="java_plain">environment</span><span class="java_separator">.</span><span class="java_plain">conf&nbsp;#&nbsp;</span><span class="java_type">Conf</span><span class="java_plain">&nbsp;file&nbsp;</span><span class="java_keyword">for</span><span class="java_plain">&nbsp;the&nbsp;environment</span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Nodes - Default classification</h2>
       
                            
     <p>A node is identified by the PuppetMaster by its <strong>certname</strong>, which defaults to the node's <strong>fqdn</strong></p>
<p>In the first manifest file parsed by the Master, <code><span class="java_plain">site</span><span class="java_separator">.</span><span class="java_plain">pp</span></code>, we can define nodes with a syntax like:</p> 
<pre class=" code"><code><span class="java_plain">node&nbsp;</span><span class="java_literal">'web01'</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;include&nbsp;apache</span>
<span class="java_separator">}</span><span class="java_plain"></span></code></pre>
<p>We can also define a list of matching names:</p> 
<pre class=" code"><code><span class="java_plain">node&nbsp;</span><span class="java_literal">'web01'</span><span class="java_plain">&nbsp;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">'web02'</span><span class="java_plain">&nbsp;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">'web03'</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;include&nbsp;apache</span>
<span class="java_separator">}</span><span class="java_plain"></span></code></pre>
<p>or use a regular expression:</p> 
<pre class=" code"><code><span class="java_plain">node&nbsp;</span><span class="java_operator">/^</span><span class="java_plain">www\d</span><span class="java_operator">+</span><span class="java_plain">$</span><span class="java_operator">/</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;include&nbsp;apache</span>
<span class="java_separator">}</span><span class="java_plain"></span></code></pre>
<p>A node can inherit another node and include all the classes and variables defined for it, this feature is now deprecated and is not supported anymore on <abbr title="Puppet automation tool">Puppet</abbr> 4.</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Nodes classification via an ENC</h2>
       
                            
     <p><abbr title="Puppet automation tool">Puppet</abbr> can query an external source to retrieve the classes and the parameters to assign to a node. This source is called External Node Classifier (ENC) and can be anything that, when interrogated via a script with the clients' certname as first parameter, returns a yaml file with the list of classes and parameters.</p>
<p>Common ENC are <strong><abbr title="Puppet automation tool">Puppet</abbr> DashBoard</strong>, <strong>The Foreman</strong> and <strong><abbr title="Puppet automation tool">Puppet</abbr> Enterprise</strong> (where the functionality of ENC is enabled by default).</p>
<p>To enable the usage of an ENC set these parameters in <code><span class="java_plain">puppet</span><span class="java_separator">.</span><span class="java_plain">conf</span></code></p> 
<pre class=" code"><code><span class="java_plain">#&nbsp;</span><span class="java_type">Enable</span><span class="java_plain">&nbsp;the&nbsp;usage&nbsp;of&nbsp;a&nbsp;script&nbsp;to&nbsp;classify&nbsp;nodes</span>
<span class="java_plain">node_terminus&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;exec</span>
<span class="java_plain"></span>
<span class="java_plain">#&nbsp;</span><span class="java_type">Path</span><span class="java_plain">&nbsp;of&nbsp;the&nbsp;script&nbsp;to&nbsp;execute&nbsp;to&nbsp;classify&nbsp;nodes&nbsp;</span>
<span class="java_plain">external_nodes&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_operator">/</span><span class="java_plain">etc</span><span class="java_operator">/</span><span class="java_plain">puppet</span><span class="java_operator">/</span><span class="java_plain">node</span><span class="java_separator">.</span><span class="java_plain">rb</span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Nodes classification with Hiera</h2>
       
                            
     <p>Hiera provides a <strong>hiera_include</strong> function that allows the inclusion of classes as defined on Hiera. This is an approach that can be useful when there's massive usage of Hiera as backend for <abbr title="Puppet automation tool">Puppet</abbr> data.</p>
<p>In <code><span class="java_operator">/</span><span class="java_plain">etc</span><span class="java_operator">/</span><span class="java_plain">puppet</span><span class="java_operator">/</span><span class="java_plain">manifests</span><span class="java_operator">/</span><span class="java_plain">site</span><span class="java_separator">.</span><span class="java_plain">pp</span></code> just place:</p> 
<pre class=" code"><code><span class="java_plain">hiera_include</span><span class="java_separator">(</span><span class="java_literal">'classes'</span><span class="java_separator">)</span><span class="java_plain"></span></code></pre>
<p>and place, as an array, the classes to include in our Hiera data source under the key <code><span class="java_plain">classes</span></code>.</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>The Catalog</h2>
       
                            
     <p>The <strong>catalog</strong> is the complete list of resources, and their relationships, that the <abbr title="Puppet automation tool">Puppet</abbr> Master generates for the client.</p>
<p>It's the result of all the puppet code and logic that we define for a given node in our manifests and is applied on the client after it has been received from the master.</p>
<p>The client uses the RAL (Resource Abstraction Layer) to execute the actual system's commands that convert abstract resources like</p> 
<pre class=" code"><code><span class="java_keyword">package</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">'openssh'</span><span class="java_operator">:</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span><span class="java_plain"></span></code></pre>
<p>to their actual fullfillment on the system (<code><span class="java_plain">apt</span><span class="java_operator">-</span><span class="java_plain">get&nbsp;install&nbsp;openssh</span></code> , <code><span class="java_plain">yum&nbsp;install&nbsp;openssh</span></code> ...).</p>
<p>The catalog is saved by the client in <code><span class="java_operator">/</span><span class="java_plain">var</span><span class="java_operator">/</span><span class="java_plain">lib</span><span class="java_operator">/</span><span class="java_plain">puppet</span><span class="java_operator">/</span><span class="java_plain">client_data</span><span class="java_operator">/</span><span class="java_plain">catalog</span><span class="java_operator">/</span><span class="java_plain">$certname</span><span class="java_separator">.</span><span class="java_plain">json</span></code></p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Language Basics - Practice</h2>
       
                            
     <p>On a test machine <strong>install <abbr title="Puppet automation tool">Puppet</abbr></strong> if not already installed.</p>
<p>Practice with the <strong>commands</strong>:</p>
<p>puppet describe<br /> puppet resource<br /> facter</p>
<p>Create a <strong>manifest</strong> file and in that file manage the installation of the package and the management of the service of <em>nginx</em>.<br />Use <code><span class="java_plain">puppet&nbsp;apply</span></code> to apply the resources declared in our manifest.</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Puppet Configuration and basic usage - Overview</h2>
       
                            
     <h3>Operational modes: apply / agent</h3> 
<h3>Configuration files and options</h3> 
<h3>Useful Paths</h3> 
<h3>Anatomy of a <abbr title="Puppet automation tool">Puppet</abbr> run</h3>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Operational modes</h2>
       
                            
     <h2>Masterless - puppet apply</h2>
<p>Our <abbr title="Puppet automation tool">Puppet</abbr> code (written in manifests) is applied directly on the target system.</p>
<p>No need of a complete client-server infrastructure.</p>
<p>Have to distribute manifests and modules to the managed nodes.</p>
<p>Command used: <code><span class="java_plain">puppet&nbsp;apply</span></code> (generally as root)</p> 
<h2>Master / Client - puppet agent</h2>
<p>We have clients, our managed nodes, where <abbr title="Puppet automation tool">Puppet</abbr> client is installed.</p>
<p>And we have one or more Masters where <abbr title="Puppet automation tool">Puppet</abbr> server runs as a service</p>
<p>Client/Server communication is via https (<strong>port 8140</strong>)</p>
<p>Clients certificates have to be accepted (<strong>signed</strong>) on the Master</p>
<p>Command used on the client: <code><span class="java_plain">puppet&nbsp;agent</span></code> (generally as <strong>root</strong>)</p>
<p>Command used on the server: <code><span class="java_plain">puppet&nbsp;master</span></code> (generally as <strong>puppet</strong>)</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Masterless setup</h2>
       
                            
     <p><abbr title="Puppet automation tool">Puppet</abbr> manifests are deployed directly on nodes and applied locally:</p> 
<pre class=" code"><code><span class="java_plain">puppet&nbsp;apply&nbsp;</span><span class="java_operator">--</span><span class="java_plain">modulepath&nbsp;</span><span class="java_operator">/</span><span class="java_plain">modules</span><span class="java_operator">/</span><span class="java_plain">&nbsp;</span><span class="java_operator">/</span><span class="java_plain">manifests</span><span class="java_operator">/</span><span class="java_plain">file</span><span class="java_separator">.</span><span class="java_plain">pp</span></code></pre>
<p>More fine grained control on what goes in production for what nodes</p>
<p>Ability to trigger multiple truly parallel <abbr title="Puppet automation tool">Puppet</abbr> runs</p>
<p>No single point of failure, no Master performance issues</p>
<p>Need to define a fitting deployment workflow. Hints: <a href="https://github.com/railsmachine/rump">Rump</a> - <a href="https://github.com/pitluga/supply_drop">supply_drop</a></p>
<p>With <abbr title="Puppet automation tool">Puppet</abbr> &gt; 2.6 we can use file sources urls like:</p> 
<pre class=" code"><code><span class="java_plain">puppet</span><span class="java_operator">:</span><span class="java_comment">///modules/example42/apache/vhost.conf</span>
<span class="java_plain"></span>
<span class="java_plain">#&nbsp;they&nbsp;point&nbsp;to</span>
<span class="java_plain">$modulepath</span><span class="java_operator">/</span><span class="java_plain">example42</span><span class="java_operator">/</span><span class="java_plain">apache</span><span class="java_operator">/</span><span class="java_plain">vhost</span><span class="java_separator">.</span><span class="java_plain">conf</span></code></pre>
<p>StoreConfigs usage require access to <abbr title="Puppet automation tool">Puppet</abbr> DB from every node</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Master / Client Setup</h2>
       
                            
     <p>A <abbr title="Puppet automation tool">Puppet</abbr> server (running as 'puppet') listening on 8140 on the <abbr title="Puppet automation tool">Puppet</abbr> Master (the server )</p>
<p>A <abbr title="Puppet automation tool">Puppet</abbr> client (running as 'root') on each managed node</p>
<p>Client can be run as a service (default), via cron (with random delays), manually or via MCollective</p>
<p>Client and Server have to share SSL certificates. New client certificates must be signed by the Master CA</p>
<p>It's possible to enable automatic clients certificates signing on the Master (be aware of security concerns)</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Certificates management</h2>
       
                            
     <p>On the Master we can use <code><span class="java_plain">puppet&nbsp;cert</span></code> to manage certificates</p>
<p>List the (client) certificates to sign:</p> 
<pre class=" code"><code><span class="java_plain">puppet&nbsp;cert&nbsp;list</span></code></pre>
<p>List all certificates: signed (+), revoked (-), to sign ( ):</p> 
<pre class=" code"><code><span class="java_plain">puppet&nbsp;cert&nbsp;list&nbsp;</span><span class="java_operator">--</span><span class="java_plain">all</span></code></pre>
<p>Sign a client certificate:</p> 
<pre class=" code"><code><span class="java_plain">puppet&nbsp;cert&nbsp;sign&nbsp;</span><span class="java_operator">&lt;</span><span class="java_plain">certname</span><span class="java_operator">&gt;</span><span class="java_plain"></span></code></pre>
<p>Remove a client certificate:</p> 
<pre class=" code"><code><span class="java_plain">puppet&nbsp;cert&nbsp;clean&nbsp;</span><span class="java_operator">&lt;</span><span class="java_plain">certname</span><span class="java_operator">&gt;</span><span class="java_plain"></span></code></pre>
<p>Client stores its certificates and the server's public one in <code><span class="java_plain">$vardir</span><span class="java_operator">/</span><span class="java_plain">ssl</span><span class="java_operator">**</span><span class="java_plain"></span></code> (<code><span class="java_operator">/</span><span class="java_plain">var</span><span class="java_operator">/</span><span class="java_plain">lib</span><span class="java_operator">/</span><span class="java_plain">puppet</span><span class="java_operator">/</span><span class="java_plain">ssl</span></code> on <abbr title="Puppet automation tool">Puppet</abbr> OpenSource)</p>
<p>Server stores clients public certificates and in <code><span class="java_plain">$vardir</span><span class="java_operator">/</span><span class="java_plain">ssl</span><span class="java_operator">/</span><span class="java_plain">ca</span></code> (<code><span class="java_operator">/</span><span class="java_plain">var</span><span class="java_operator">/</span><span class="java_plain">lib</span><span class="java_operator">/</span><span class="java_plain">puppet</span><span class="java_operator">/</span><span class="java_plain">ssl</span><span class="java_operator">/</span><span class="java_plain">ca</span></code>). DO NOT remove this directory.</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Certificates management - First run</h2>
       
                            
     <p>By default the first <abbr title="Puppet automation tool">Puppet</abbr> run on a client fails:</p> 
<pre class=" code"><code><span class="java_plain">client&nbsp;#&nbsp;puppet&nbsp;agent&nbsp;</span><span class="java_operator">-</span><span class="java_plain">t</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;</span><span class="java_literal">&quot;Exiting;&nbsp;no&nbsp;certificate&nbsp;found&nbsp;and&nbsp;waitforcert&nbsp;is&nbsp;disabled&quot;</span><span class="java_plain"></span></code></pre>
<p>An optional `<code><span class="java_operator">--</span><span class="java_plain">waitforcert&nbsp;</span><span class="java_literal">60</span><span class="java_plain"></span></code> parameter makes client wait 60 seconds before giving up.</p>
<p>The server has received the client's CSR which has to be manually signed:</p> 
<pre class=" code"><code><span class="java_plain">server&nbsp;#&nbsp;puppet&nbsp;cert&nbsp;sign&nbsp;</span><span class="java_operator">&lt;</span><span class="java_plain">certname</span><span class="java_operator">&gt;</span><span class="java_plain"></span></code></pre>
<p>Once signed on the Master, the client can connect and receive its catalog:</p> 
<pre class=" code"><code><span class="java_plain">client&nbsp;#&nbsp;puppet&nbsp;agent&nbsp;</span><span class="java_operator">-</span><span class="java_plain">t</span></code></pre>
<p>If we have issues with certificates (reinstalled client or other certs related problemes):</p>
<p>Be sure client and server times are synced</p>
<p>Clean up the client certificate. On the client remove it:</p> 
<pre class=" code"><code><span class="java_plain">client&nbsp;#&nbsp;mv&nbsp;</span><span class="java_operator">/</span><span class="java_plain">var</span><span class="java_operator">/</span><span class="java_plain">lib</span><span class="java_operator">/</span><span class="java_plain">puppet</span><span class="java_operator">/</span><span class="java_plain">ssl&nbsp;</span><span class="java_operator">/</span><span class="java_plain">var</span><span class="java_operator">/</span><span class="java_plain">lib</span><span class="java_operator">/</span><span class="java_plain">puppet</span><span class="java_operator">/</span><span class="java_plain">ssl</span><span class="java_separator">.</span><span class="java_plain">old</span></code></pre>
<p>On the Master clean the old client certificate:</p> 
<pre class=" code"><code><span class="java_plain">server&nbsp;#&nbsp;puppet&nbsp;cert&nbsp;clean&nbsp;</span><span class="java_operator">&lt;</span><span class="java_plain">certname</span><span class="java_operator">&gt;</span><span class="java_plain"></span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Puppet configuration: puppet.conf</h2>
       
                            
     <p>It's <abbr title="Puppet automation tool">Puppet</abbr> main configuration file.<br />On opensource <abbr title="Puppet automation tool">Puppet</abbr> is generally in:</p> 
<pre class=" code"><code><span class="java_operator">/</span><span class="java_plain">etc</span><span class="java_operator">/</span><span class="java_plain">puppet</span><span class="java_operator">/</span><span class="java_plain">puppet</span><span class="java_separator">.</span><span class="java_plain">conf</span></code></pre>
<p>On <abbr title="Puppet automation tool">Puppet</abbr> Enterprise:</p> 
<pre class=" code"><code><span class="java_operator">/</span><span class="java_plain">etc</span><span class="java_operator">/</span><span class="java_plain">puppetlabs</span><span class="java_operator">/</span><span class="java_plain">puppet</span><span class="java_operator">/</span><span class="java_plain">puppet</span><span class="java_separator">.</span><span class="java_plain">conf</span></code></pre>
<p>When running as a normal user can be placed in the home directory:</p> 
<pre class=" code"><code><span class="java_operator">/</span><span class="java_plain">home</span><span class="java_operator">/</span><span class="java_plain">user</span><span class="java_operator">/</span><span class="java_separator">.</span><span class="java_plain">puppet</span><span class="java_operator">/</span><span class="java_plain">puppet</span><span class="java_separator">.</span><span class="java_plain">conf</span></code></pre>
<p>Configurations are divided in [stanzas] for different <abbr title="Puppet automation tool">Puppet</abbr> sub commands</p>
<p>Common for all commands: <strong>[main]</strong></p>
<p>For puppet agent (client): <strong>[agent]</strong> (Was [puppetd] in <abbr title="Puppet automation tool">Puppet</abbr> pre 2.6)</p>
<p>For puppet apply (client): <strong>[user]</strong> (Was [puppet])</p>
<p>For puppet master (server): <strong>[master]</strong> (Was [puppetmasterd] and [puppetca])</p>
<p>Hash sign (#) can be used for comments.</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Main configuration options</h2>
       
                            
     <p>To view all or a specific configuration setting:</p> 
<pre class=" code"><code><span class="java_plain">puppet&nbsp;config&nbsp;print&nbsp;all</span>
<span class="java_plain">puppet&nbsp;config&nbsp;print&nbsp;modulepath</span></code></pre> 
<h3>Important options under <strong>[main]</strong> section:</h3>
<p><strong>vardir</strong>: Path where <abbr title="Puppet automation tool">Puppet</abbr> stores dynamic data.</p>
<p><strong>ssldir</strong>: Path where SSL certifications are stored.</p> 
<h3>Under <strong>[agent]</strong> section:</h3>
<p><strong>server</strong>: Host name of the PuppetMaster. (Default: puppet)</p>
<p><strong>certname</strong>: Certificate name used by the client. (Default is its fqdn)</p>
<p><strong>runinterval</strong>: Number of minutes between <abbr title="Puppet automation tool">Puppet</abbr> runs, when running as service. (Default: 30)</p>
<p><strong>report</strong>: If to send <abbr title="Puppet automation tool">Puppet</abbr> runs' reports to the **report_server. (Default: true)</p> 
<h3>Under <strong>[master]</strong> section:</h3>
<p><strong>autosign</strong>: If new clients certificates are automatically signed. (Default: false)</p>
<p><strong>reports</strong>: How to manage clients' reports (Default: store)</p>
<p><strong>storeconfigs</strong>: If to enable store configs to support exported resources. (Default: false)</p>
<p>Full <a href="http://docs.puppetlabs.com/references/latest/configuration.html">configuration reference</a> on the official site.</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Common command-line parameters</h2>
       
                            
     <p>All configuration options can be overriden by command-line options.</p>
<p>A very common option used when we want to see immediately the effect of a <abbr title="Puppet automation tool">Puppet</abbr> run (it's actually the combination of: -onetime, -verbose, -ignorecache, -no-daemonize, -no-usecacheonfailure, -detailed-exit-codes, -no-splay, and -show_diff):</p> 
<pre class=" code"><code><span class="java_plain">puppet&nbsp;agent&nbsp;</span><span class="java_operator">--</span><span class="java_plain">test&nbsp;#&nbsp;</span><span class="java_type">Can</span><span class="java_plain">&nbsp;be&nbsp;abbreviate&nbsp;to&nbsp;</span><span class="java_operator">-</span><span class="java_plain">t</span></code></pre>
<p>Run puppet agent in foreground and debug mode:</p> 
<pre class=" code"><code><span class="java_plain">puppet&nbsp;agent&nbsp;</span><span class="java_operator">--</span><span class="java_plain">test&nbsp;</span><span class="java_operator">--</span><span class="java_plain">debug</span></code></pre>
<p>Run a dry-run puppet without making any change to the system:</p> 
<pre class=" code"><code><span class="java_plain">puppet&nbsp;agent&nbsp;</span><span class="java_operator">--</span><span class="java_plain">test&nbsp;</span><span class="java_operator">--</span><span class="java_plain">noop</span></code></pre>
<p>Run puppet using an environment different from the default one:</p> 
<pre class=" code"><code><span class="java_plain">puppet&nbsp;agent&nbsp;</span><span class="java_operator">--</span><span class="java_plain">test&nbsp;</span><span class="java_operator">--</span><span class="java_plain">environment&nbsp;testing</span></code></pre>
<p>Wait for certificate approval (by default 120 seconds) in the first <abbr title="Puppet automation tool">Puppet</abbr> run (useful during automated first fime installation if PuppetMaster's autosign is false):</p> 
<pre class=" code"><code><span class="java_plain">puppet&nbsp;agent&nbsp;</span><span class="java_operator">--</span><span class="java_plain">test&nbsp;</span><span class="java_operator">--</span><span class="java_plain">waitforcert&nbsp;</span><span class="java_literal">120</span><span class="java_plain"></span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Useful paths</h2>
       
                            
     <p><strong>/var/log/puppet</strong> contains logs (but also on normal syslog files, with facility daemon), both for agents and master</p>
<p><strong>/var/lib/puppet</strong> contains <abbr title="Puppet automation tool">Puppet</abbr> operational data (catalog, certs, backup of files...)</p>
<p><strong>/var/lib/puppet/ssl</strong>&nbsp;contains SSL certificate</p>
<p><strong>/var/lib/puppet/clientbucket</strong> contains backup copies of the files changed by <abbr title="Puppet automation tool">Puppet</abbr></p>
<p><strong>/etc/puppet/manifests/site.pp</strong> (On Master) The first manifest that the master parses when a client connects in order to produce the configuration to apply to it (Default on <abbr title="Puppet automation tool">Puppet</abbr> &lt; 3.6 where are used <strong>config-file environments</strong>)</p>
<p><strong>/etc/puppet/environments/production/manifests/site.pp</strong> (On Master) The first manifest that the master parses when using <strong>directory environments</strong> (recommended from <abbr title="Puppet automation tool">Puppet</abbr> 3.6 and default on Puppt &gt;= 4)</p>
<p><strong>/etc/puppet/modules</strong> and <strong>/usr/share/puppet/modules</strong> (On Master) The default directories where modules are searched</p>
<p><strong>/etc/puppet/environments/production/modules</strong> (On Master) An extra place where modules are looked for when using <strong>directory environments</strong></p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Other configuration files:</h2>
       
                            
     <h4><strong>auth.conf</strong></h4>
<p>Defines ACLs to access <abbr title="Puppet automation tool">Puppet</abbr>'s REST interface. <a href="http://docs.puppetlabs.com/guides/rest_auth_conf.html">Details</a></p> 
<h4><strong>fileserver.conf</strong></h4>
<p>Used to manage ACL on files served from sources different than modules <a href="http://docs.puppetlabs.com/guides/file_serving.html">Details</a></p> 
<h4><strong>puppetdb.conf</strong></h4>
<p>Settings for connection to PuppetDB, if used. <a href="http://docs.puppetlabs.com/puppetdb/1/">Details</a></p> 
<h4><strong>tagmail.conf</strong> , <strong>autosign.conf</strong> , <strong>device.conf</strong> , <strong>routes.yaml</strong></h4>
<p>These are other configuration files for specific functions. <a href="http://docs.puppetlabs.com/guides/configuring.html">Details</a></p> 
<h4><strong>/etc/puppet/environments/production/environment.conf</strong></h4>
<p>Contains environment specific settings</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Anatomy of a Puppet Run - Part 1: Catalog compilation</h2>
       
                            
     <p>Execute <abbr title="Puppet automation tool">Puppet</abbr> on the client</p>
<p>Client shell # puppet agent -t</p>
<p>If pluginsync = true (default from <abbr title="Puppet automation tool">Puppet</abbr> 3.0) the client retrieves all extra plugins (facts, types and providers) present in modules on the server's $modulepath</p>
<p>Client output # Info: Retrieving plugin</p>
<p>The client runs facter and send its facts to the server</p>
<p>Client output # Info: Loading facts in /var/lib/puppet/lib/facter/... [...]</p>
<p>The server looks for the client's hostname (or certname, if different from the hostname) and looks into its nodes list</p>
<p>The server compiles the catalog for the client using also client's facts</p>
<p>Server's logs # Compiled catalog for in environment production in 8.22 seconds</p>
<p>If there are not syntax errors in the processed <abbr title="Puppet automation tool">Puppet</abbr> code, the server sends the catalog to the client, in PSON format.</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Anatomy of a Puppet Run - Part 2: Catalog application</h2>
       
                            
     <p>Client output # Info: Caching catalog for </p>
<p>The client receives the catalog and starts to apply it locally<br />If there are dependency loops the catalog can't be applied and the whole tun fails.</p>
<p>Client output # Info: Applying configuration version '1355353107'</p>
<p>All changes to the system are shown here. If there are errors (in red or pink, according to <abbr title="Puppet automation tool">Puppet</abbr> versions) they are relevant to specific resources but do not block the application of the other resources (unless they depend on the failed ones).</p>
<p>At the end ot the <abbr title="Puppet automation tool">Puppet</abbr> run the client sends to the server a report of what has been changed</p>
<p>Client output # Finished catalog run in 13.78 seconds</p>
<p>The server eventually sends the report to a Report Collector</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Puppet Configuration and basic usage - Practice</h2>
       
                            
     <p>Use the command <code><span class="java_plain">puppet&nbsp;config&nbsp;print</span></code> to explore <abbr title="Puppet automation tool">Puppet</abbr>'s configuration options.</p>
<p>Give a look to the various <abbr title="Puppet automation tool">Puppet</abbr> related directories and their contents:<br /><code><span class="java_operator">/</span><span class="java_plain">etc</span><span class="java_operator">/</span><span class="java_plain">puppet</span></code>, <code><span class="java_operator">/</span><span class="java_plain">var</span><span class="java_operator">/</span><span class="java_plain">lib</span><span class="java_operator">/</span><span class="java_plain">puppet</span></code>, <code><span class="java_operator">/</span><span class="java_plain">var</span><span class="java_operator">/</span><span class="java_plain">log</span><span class="java_operator">/</span><span class="java_plain">puppet</span></code></p>
<p>If the lab setup allows it, run <abbr title="Puppet automation tool">Puppet</abbr> on a new client and sign its certificate on the master.</p>
<p>Explore and describe the output of a <abbr title="Puppet automation tool">Puppet</abbr> run in apply and agent mode.</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Resources reference - Overview</h2>
       
                            
     <h3>Where to find docs about <abbr title="Puppet automation tool">Puppet</abbr> resources</h3> 
<h3>Main resources: package, service, file, user, exec</h3> 
<h3>Language Style</h3>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Online documentation on types</h2>
       
                            
     <h4>Complete <a href="http://docs.puppetlabs.com/references/latest/type.html">Type Reference</a></h4>
<p>This is the complete reference for <abbr title="Puppet automation tool">Puppet</abbr> types based on the latest version.</p>
<p>Check <a href="http://docs.puppetlabs.com/references/index.html">here</a> for the reference on all the older versions.</p>
<p>Check the <abbr title="Puppet automation tool">Puppet</abbr> Core <a href="http://docs.puppetlabs.com/puppet_core_types_cheatsheet.pdf">Types Cheatsheet</a> for an handy PDF with the essential reference.</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Inline documentation on types</h2>
       
                            
     <h4>Types reference documentation</h4>
<p>We can check all the types documentation via the command line:</p> 
<pre class=" code"><code><span class="java_plain">puppet&nbsp;describe&nbsp;</span><span class="java_operator">&lt;</span><span class="java_plain">type</span><span class="java_operator">&gt;</span><span class="java_plain"></span></code></pre>
<p>For a more compact output:</p> 
<pre class=" code"><code><span class="java_plain">puppet&nbsp;describe&nbsp;</span><span class="java_operator">-</span><span class="java_plain">s&nbsp;</span><span class="java_operator">&lt;</span><span class="java_plain">type</span><span class="java_operator">&gt;</span><span class="java_plain"></span></code></pre>
<p>To show all the available resource types:</p> 
<pre class=" code"><code><span class="java_plain">puppet&nbsp;describe&nbsp;</span><span class="java_operator">-</span><span class="java_plain">l</span></code></pre> 
<h4>Inspect existing resource types</h4>
<p>To interactively inspect and modify our system's resources</p> 
<pre class=" code"><code><span class="java_plain">puppet&nbsp;resource&nbsp;</span><span class="java_operator">&lt;</span><span class="java_plain">type</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;</span><span class="java_separator">[</span><span class="java_plain">name</span><span class="java_separator">]</span><span class="java_plain"></span></code></pre>
<p>Remember we can use the same command to CHANGE our resources attibutes:</p> 
<pre class=" code"><code><span class="java_plain">puppet&nbsp;resource&nbsp;</span><span class="java_operator">&lt;</span><span class="java_plain">type</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;</span><span class="java_operator">&lt;</span><span class="java_plain">name</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;</span><span class="java_separator">[</span><span class="java_plain">attribute</span><span class="java_operator">=</span><span class="java_plain">value</span><span class="java_separator">]</span><span class="java_plain">&nbsp;</span><span class="java_separator">[</span><span class="java_plain">attribute2</span><span class="java_operator">=</span><span class="java_plain">value2</span><span class="java_separator">]</span><span class="java_plain"></span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Managing packages</h2>
       
                            
     <p>Installation of packages is managed by the <strong>package</strong> type.</p>
<p>The main arguments:</p> 
<pre class=" code"><code><span class="java_keyword">package</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">'apache'</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'httpd'</span><span class="java_separator">,</span><span class="java_plain">&nbsp;&nbsp;#&nbsp;</span><span class="java_separator">(</span><span class="java_plain">namevar</span><span class="java_separator">)</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;ensure&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'present'</span><span class="java_plain">&nbsp;#&nbsp;</span><span class="java_type">Values</span><span class="java_operator">:</span><span class="java_plain">&nbsp;</span><span class="java_literal">'absent'</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">'latest'</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">'2.2.1'</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;provider&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;undef</span><span class="java_separator">,</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;</span><span class="java_type">Force</span><span class="java_plain">&nbsp;an&nbsp;explicit&nbsp;provider</span>
<span class="java_separator">}</span><span class="java_plain"></span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Managing services</h2>
       
                            
     <p>Management of services is via the <strong>service</strong> type.</p>
<p>The main arguments:</p> 
<pre class=" code"><code><span class="java_plain">service&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">'apache'</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'httpd'</span><span class="java_separator">,</span><span class="java_plain">&nbsp;&nbsp;#&nbsp;</span><span class="java_separator">(</span><span class="java_plain">namevar</span><span class="java_separator">)</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;ensure&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'running'</span><span class="java_plain">&nbsp;#&nbsp;</span><span class="java_type">Values</span><span class="java_operator">:</span><span class="java_plain">&nbsp;</span><span class="java_literal">'stopped'</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">'running'</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;enable&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">true</span><span class="java_separator">,</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;</span><span class="java_type">Define</span><span class="java_plain">&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;to&nbsp;enable&nbsp;service&nbsp;at&nbsp;boot&nbsp;</span><span class="java_separator">(</span><span class="java_literal">true</span><span class="java_operator">|</span><span class="java_literal">false</span><span class="java_separator">)</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;hasstatus&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">true</span><span class="java_separator">,</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;</span><span class="java_type">Whether</span><span class="java_plain">&nbsp;to&nbsp;use&nbsp;the&nbsp;init&nbsp;script</span><span class="java_literal">'&nbsp;status&nbsp;to&nbsp;check</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;the&nbsp;service&nbsp;is&nbsp;running</span><span class="java_separator">.</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;pattern&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'httpd'</span><span class="java_separator">,</span><span class="java_plain">&nbsp;&nbsp;#&nbsp;</span><span class="java_type">Name</span><span class="java_plain">&nbsp;of&nbsp;the&nbsp;process&nbsp;to&nbsp;look&nbsp;</span><span class="java_keyword">for</span><span class="java_plain">&nbsp;when&nbsp;hasstatus</span><span class="java_operator">=</span><span class="java_literal">false</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Managing files</h2>
       
                            
     <p>Files are the most configured resources on a system, we manage them with the <strong>file</strong> type:</p> 
<pre class=" code"><code><span class="java_plain">file&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">'httpd.conf'</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;</span><span class="java_separator">(</span><span class="java_plain">namevar</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_type">The</span><span class="java_plain">&nbsp;file&nbsp;path</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;path&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'/etc/httpd/conf/httpd.conf'</span><span class="java_separator">,</span><span class="java_plain">&nbsp;&nbsp;</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;</span><span class="java_type">Define</span><span class="java_plain">&nbsp;the&nbsp;file&nbsp;type&nbsp;and&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;it&nbsp;should&nbsp;exist</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;</span><span class="java_literal">'present'</span><span class="java_separator">,</span><span class="java_literal">'absent'</span><span class="java_separator">,</span><span class="java_literal">'directory'</span><span class="java_separator">,</span><span class="java_literal">'link'</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;ensure&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'present'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;</span><span class="java_type">Url</span><span class="java_plain">&nbsp;from&nbsp;where&nbsp;to&nbsp;retrieve&nbsp;the&nbsp;file&nbsp;content</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;source&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'puppet://[puppetfileserver]/&lt;share&gt;/path'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;</span><span class="java_type">Actual</span><span class="java_plain">&nbsp;content&nbsp;of&nbsp;the&nbsp;file</span><span class="java_separator">,</span><span class="java_plain">&nbsp;alternative&nbsp;to&nbsp;source</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;</span><span class="java_type">Typically</span><span class="java_plain">&nbsp;it&nbsp;contains&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;template&nbsp;function</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;content&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'My&nbsp;content'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;</span><span class="java_type">Typical</span><span class="java_plain">&nbsp;file</span><span class="java_literal">'s&nbsp;attributes</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;owner&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'root'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;group&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'root'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;mode&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'0644'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;</span><span class="java_type">The</span><span class="java_plain">&nbsp;sylink&nbsp;target</span><span class="java_separator">,</span><span class="java_plain">&nbsp;when&nbsp;ensure&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;link</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;target&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'/etc/httpd/httpd.conf'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;</span><span class="java_type">Whether</span><span class="java_plain">&nbsp;to&nbsp;recursively&nbsp;manage&nbsp;a&nbsp;directory&nbsp;</span><span class="java_separator">(</span><span class="java_plain">when&nbsp;ensure&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;directory</span><span class="java_separator">)</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;recurse&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">true</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Executing commands</h2>
       
                            
     <p>We can run plain commands using <abbr title="Puppet automation tool">Puppet</abbr>'s <strong>exec</strong> type. Since <abbr title="Puppet automation tool">Puppet</abbr> applies it at every run, either the command can be safely run multiple times or we have to use one of the <strong>creates</strong>, <strong>unless</strong>, <strong>onlyif</strong>, <strong>refreshonly</strong> arguments to manage when to execute it.</p> 
<pre class=" code"><code><span class="java_plain">exec&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">'get_my_file'</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;</span><span class="java_separator">(</span><span class="java_plain">namevar</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_type">The</span><span class="java_plain">&nbsp;command&nbsp;to&nbsp;execute</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;command&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;wget&nbsp;http://mysite/myfile.tar.gz&nbsp;-O&nbsp;/tmp/myfile.tar.gz',</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;</span><span class="java_type">The</span><span class="java_plain">&nbsp;search&nbsp;path&nbsp;</span><span class="java_keyword">for</span><span class="java_plain">&nbsp;the&nbsp;command</span><span class="java_separator">.</span><span class="java_plain">&nbsp;</span><span class="java_type">Must</span><span class="java_plain">&nbsp;exist&nbsp;when&nbsp;command&nbsp;is&nbsp;not&nbsp;absolute</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;</span><span class="java_type">Often</span><span class="java_plain">&nbsp;set&nbsp;in&nbsp;</span><span class="java_type">Exec</span><span class="java_plain">&nbsp;resource&nbsp;defaults</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;path&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'/sbin:/bin:/usr/sbin:/usr/bin'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;A&nbsp;file&nbsp;created&nbsp;by&nbsp;the&nbsp;command</span><span class="java_separator">.</span><span class="java_plain">&nbsp;</span><span class="java_type">It</span><span class="java_plain">&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;exists</span><span class="java_separator">,</span><span class="java_plain">&nbsp;the&nbsp;command&nbsp;is&nbsp;not&nbsp;executed</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;creates&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'/tmp/myfile.tar.gz'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;A&nbsp;command&nbsp;or&nbsp;an&nbsp;array&nbsp;of&nbsp;commands</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;any&nbsp;of&nbsp;them&nbsp;returns&nbsp;an&nbsp;error</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;the&nbsp;command&nbsp;is&nbsp;not&nbsp;executed</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;onlyif&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'ls&nbsp;/tmp/myfile.tar.gz&nbsp;&amp;&amp;&nbsp;false'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;A&nbsp;command&nbsp;or&nbsp;an&nbsp;array&nbsp;of&nbsp;commands</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;any&nbsp;of&nbsp;them&nbsp;returns&nbsp;an&nbsp;error</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;the&nbsp;command&nbsp;IS&nbsp;executed</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;unless&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'ls&nbsp;/tmp/myfile.tar.gz'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Managing users</h2>
       
                            
     <p><abbr title="Puppet automation tool">Puppet</abbr> has native types to manage users and groups, allowing easy addition, modification and removal. Here are the main arguments of the <strong>user</strong> type:</p> 
<pre class=" code"><code><span class="java_plain">user&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">'joe'</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;</span><span class="java_separator">(</span><span class="java_plain">namevar</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_type">The</span><span class="java_plain">&nbsp;user&nbsp;name</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'joe'</span><span class="java_separator">,</span><span class="java_plain">&nbsp;&nbsp;</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;</span><span class="java_type">The</span><span class="java_plain">&nbsp;user</span><span class="java_literal">'s&nbsp;status:&nbsp;'</span><span class="java_plain">present</span><span class="java_literal">','</span><span class="java_plain">absent</span><span class="java_literal">','</span><span class="java_plain">role</span><span class="java_literal">'</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;ensure&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'present'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;</span><span class="java_type">The</span><span class="java_plain">&nbsp;user</span><span class="java_literal">'s&nbsp;&nbsp;id</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;uid&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'1001'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;</span><span class="java_type">The</span><span class="java_plain">&nbsp;user</span><span class="java_literal">'s&nbsp;primary&nbsp;group&nbsp;id</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;gid&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'1001'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;</span><span class="java_type">Eventual</span><span class="java_plain">&nbsp;user</span><span class="java_literal">'s&nbsp;secondary&nbsp;groups&nbsp;(use&nbsp;array&nbsp;for&nbsp;many)</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;groups&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_separator">[</span><span class="java_plain">&nbsp;</span><span class="java_literal">'admins'</span><span class="java_plain">&nbsp;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">'developers'</span><span class="java_plain">&nbsp;</span><span class="java_separator">],</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;</span><span class="java_type">The</span><span class="java_plain">&nbsp;user</span><span class="java_literal">'s&nbsp;password.&nbsp;As&nbsp;it&nbsp;appears&nbsp;in&nbsp;/etc/shadow</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;</span><span class="java_type">Use</span><span class="java_plain">&nbsp;single&nbsp;quotes&nbsp;to&nbsp;avoid&nbsp;unanted&nbsp;evaluation&nbsp;of&nbsp;$</span><span class="java_operator">*</span><span class="java_plain">&nbsp;as&nbsp;variables</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;password&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'$6$ZFS5JFFRZc$FFDSvPZSSFGVdXDlHe�'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;</span><span class="java_type">Typical</span><span class="java_plain">&nbsp;users</span><span class="java_literal">'&nbsp;attributes</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;shell&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'/bin/bash'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;home&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'/home/joe'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;mode&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'0644'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Puppet language style</h2>
       
                            
     <p><abbr title="Puppet automation tool">Puppet</abbr> language as an official <a href="http://docs.puppetlabs.com/guides/style_guide.html">Style Guide</a> which defines recommended rules on how to write the code.</p>
<p>The standard de facto tool to check the code style is <a href="http://puppet-lint.com/">puppet-lint</a>.</p>
<p>Badly formatted example:</p> 
<pre class=" code"><code><span class="java_plain">file&nbsp;</span><span class="java_separator">{</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;</span><span class="java_literal">&quot;/etc/issue&quot;</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;content&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Welcome&nbsp;to&nbsp;$fqdn&quot;</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ensure&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;present</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mode&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">644</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;group&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;root&quot;</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;path&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;${issue_file_path}&quot;</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span><span class="java_plain"></span></code></pre>
<p>Corrected style:</p> 
<pre class=" code"><code><span class="java_plain">file&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">'/etc/issue'</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;ensure&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;present</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;content&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Welcome&nbsp;to&nbsp;${fqdn}&quot;</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;mode&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">0644</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;group&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'root'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;path&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;$issue_file_path</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Resources reference - Practice</h2>
       
                            
     <p>Create a manifest that contains all the explored resources: package, service, file, exec, user.</p>
<p>Use Pupppet Lint to verify its style.</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Language reference - Overview</h2>
       
                            
     <h3>Referencing a resource</h3> 
<h3>Managing resources ordering</h3> 
<h3>Metaparameters</h3> 
<h3>Conditionals and</h3> 
<h3>Comparison operators</h3> 
<h3>Nodes and classes inheritance</h3>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Resource references</h2>
       
                            
     <p>In <abbr title="Puppet automation tool">Puppet</abbr> any resource is uniquely identified by its type and its name.<br />We can't have 2 resources of the same type with the same name in a catalog.</p>
<p>We have seen that we declare resources with a syntax like:</p> 
<pre class=" code"><code><span class="java_plain">type&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">'name'</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;arguments&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;values</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span></code></pre>
<p>When we need to reference to them in our code the syntax is like:</p> 
<pre class=" code"><code><span class="java_type">Type</span><span class="java_separator">[</span><span class="java_literal">'name'</span><span class="java_separator">]</span><span class="java_plain"></span></code></pre>
<p>Some examples:</p> 
<pre class=" code"><code><span class="java_plain">file&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">'motd'</span><span class="java_operator">:</span><span class="java_plain">&nbsp;</span><span class="java_separator">...</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span><span class="java_plain"></span>
<span class="java_plain">apache</span><span class="java_operator">::</span><span class="java_plain">virtualhost&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">'example42.com'</span><span class="java_operator">:</span><span class="java_plain">&nbsp;</span><span class="java_separator">....</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span><span class="java_plain"></span>
<span class="java_plain">exec&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">'download_myapp'</span><span class="java_operator">:</span><span class="java_plain">&nbsp;</span><span class="java_separator">....</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span><span class="java_plain"></span></code></pre>
<p>are referenced, respectively, with</p> 
<pre class=" code"><code><span class="java_type">File</span><span class="java_separator">[</span><span class="java_literal">'motd'</span><span class="java_separator">]</span><span class="java_plain"></span>
<span class="java_type">Apache</span><span class="java_operator">::</span><span class="java_type">Virtualhost</span><span class="java_separator">[</span><span class="java_literal">'example42.com'</span><span class="java_separator">]</span><span class="java_plain"></span>
<span class="java_type">Exec</span><span class="java_separator">[</span><span class="java_literal">'download_myapp'</span><span class="java_separator">]</span><span class="java_plain"></span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Resource defaults</h2>
       
                            
     <p>It's possible to set default argument values for a resource in order to reduce code duplication. The syntax is:</p> 
<pre class=" code"><code><span class="java_type">Type</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;argument&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;value</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span></code></pre>
<p>Common examples:</p> 
<pre class=" code"><code><span class="java_type">Exec</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;path&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'/sbin:/bin:/usr/sbin:/usr/bin'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span>
<span class="java_plain"></span>
<span class="java_type">File</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;mode&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">0644</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;owner&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'root'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;group&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'root'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span></code></pre>
<p>Resource defaults can be overriden when declaring a specific resource of the same type.</p>
<p>Note that the &quot;Area of Effect&quot; of resource defaults might bring unexpected results. The general suggestion is:</p>
<p>Place <strong>global</strong> resource defaults in /etc/pupept/manifests/site.pp outside any node definition.</p>
<p>Place <strong>local</strong> resource defaults at the beginning of a class that uses them (mostly for clarity sake, as they are parse-order independent).</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Nodes inheritance</h2>
       
                            
     <p>On the PuppetMaster we can define with the <strong>node</strong> definition the resources to apply to any node.</p>
<p>It is possible to have an inheritance structure for nodes, so that resources defined for a node are automatically included in an inheriting node.</p>
<p>An example:</p> 
<pre class=" code"><code><span class="java_plain">node&nbsp;</span><span class="java_literal">'general'</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_separator">...</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span><span class="java_plain"></span>
<span class="java_plain"></span>
<span class="java_plain">node&nbsp;</span><span class="java_literal">'www01'</span><span class="java_plain">&nbsp;inherits&nbsp;general&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_separator">...</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span><span class="java_plain"></span></code></pre>
<p>In <abbr title="Puppet automation tool">Puppet</abbr> versions prior to 3, it was possible to use nodes inheritance also to set variables and override them at different inheritance levels, and refer to these variables with their &quot;short&quot; name (not fully qualified).<br />When using this approach it was important to avoid the inclusion on classes in the inheritance tree, since some variables could be evaluated in an unexpected way.</p>
<p>This is no more possible because variables are not more dynamically scoped, and generally speaking nodes inheritance has been deprecated.</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Class inheritance</h2>
       
                            
     <p>In <abbr title="Puppet automation tool">Puppet</abbr> classes are just containers of resources and have nothing to do with OOP classes. Therefore the meaning of class inheritance is somehow limited to few specific cases.</p>
<p>When using class inheritance, the main class ('puppet' in the sample below) is always evaluated first and all the variables and resource defaults it sets are available in the scope of the child class ('puppet::server').</p>
<p>Moreover the child class can override the arguments of a resource defined in the main class. Note the syntax used when referring to the existing resource File['/etc/puppet/puppet.conf']:</p> 
<pre class=" code"><code><span class="java_keyword">class</span><span class="java_plain">&nbsp;puppet&nbsp;</span><span class="java_separator">{</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;file&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">'/etc/puppet/puppet.conf'</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;content&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;template</span><span class="java_separator">(</span><span class="java_literal">'puppet/client/puppet.conf'</span><span class="java_separator">),</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span>
<span class="java_plain"></span>
<span class="java_keyword">class</span><span class="java_plain">&nbsp;puppet</span><span class="java_operator">::</span><span class="java_plain">server&nbsp;inherits&nbsp;puppet&nbsp;</span><span class="java_separator">{</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;</span><span class="java_type">File</span><span class="java_separator">[</span><span class="java_literal">'/etc/puppet/puppet.conf'</span><span class="java_separator">]</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;content&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;template</span><span class="java_separator">(</span><span class="java_literal">'puppet/server/puppet.conf'</span><span class="java_separator">),</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Run Stages</h2>
       
                            
     <p>In <abbr title="Puppet automation tool">Puppet</abbr> 2.6 it has been introduced the concept of Run Stages to help users in managing the order of dependencies when applying resources.</p>
<p><abbr title="Puppet automation tool">Puppet</abbr> (&gt; 2.6) provides a default <strong>main</strong> stage, we can add any number or further stages with the stage resource type:</p> 
<pre class=" code"><code><span class="java_plain">stage&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">'pre'</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;before&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_type">Stage</span><span class="java_separator">[</span><span class="java_literal">'main'</span><span class="java_separator">],</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span></code></pre>
<p>Which is equivalent to:</p> 
<pre class=" code"><code><span class="java_plain">stage&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">'pre'</span><span class="java_operator">:</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span><span class="java_plain"></span>
<span class="java_type">Stage</span><span class="java_separator">[</span><span class="java_literal">'pre'</span><span class="java_separator">]</span><span class="java_plain">&nbsp;</span><span class="java_operator">-&gt;</span><span class="java_plain">&nbsp;</span><span class="java_type">Stage</span><span class="java_separator">[</span><span class="java_literal">'main'</span><span class="java_separator">]</span><span class="java_plain"></span></code></pre>
<p>We can assign any class to a defined stage with the stage metaparameter:</p> 
<pre class=" code"><code><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">'yum'</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;stage&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'pre'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span></code></pre>
<p>Do not abuse of run stages (be vary of dependency cycles)!</p>
<p><a href="http://docs.puppetlabs.com/puppet/latest/reference/lang_run_stages.html">Official documentation on Run Stages</a></p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Metaparameters</h2>
       
                            
     <p>Metaparameters are parameters available to any resource type, they can be used for different purposes:</p>
<p>Manage dependencies (<strong>before</strong>, <strong>require</strong>, <strong>subscribe</strong>, <strong>notify</strong>, <strong>stage</strong>)</p>
<p>Manage resources' application policies (<strong>audit</strong>, <strong>noop</strong>, <strong>schedule</strong>, <strong>loglevel</strong>)</p>
<p>Add information to a resource (<strong>alias</strong>, <strong>tag</strong>)</p>
<p><a href="http://docs.puppetlabs.com/puppet/latest/reference/metaparameter.html">Official documentation on Metaparameters</a></p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Managing dependencies</h2>
       
                            
     <p><abbr title="Puppet automation tool">Puppet</abbr> language is declarative and not procedural: it defines states, the order in which resources are written in manifests does not affect the order in which they are applied to the desired state.</p>
<p>To manage resources ordering, there are 3 different methods, which can cohexist:</p>
<p>1 - Use the metaparameters <strong>before</strong>, <strong>require</strong>, <strong>notify</strong>, <strong>subscribe</strong></p>
<p>2 - Use the <strong>Chaining arrows</strong> (compared to the above metaparamers: <strong>-&gt;</strong> , <strong>&lt;-</strong> , <strong>&lt;~</strong> , <strong>~&gt;</strong>)</p>
<p>3 - Use run stages</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Managing dependencies - before | notify</h2>
       
                            
     <p>In a typical Package/Service/Configuration file example we want the package to be installed first, configure it and then start the service, eventually managing its restart if the config file changes.</p>
<p>This can be expressed with metaparameters:</p> 
<pre class=" code"><code><span class="java_keyword">package</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">'exim'</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;before&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_type">File</span><span class="java_separator">[</span><span class="java_literal">'exim.conf'</span><span class="java_separator">],</span><span class="java_plain">&nbsp;&nbsp;</span>
<span class="java_separator">}</span><span class="java_plain"></span>
<span class="java_plain"></span>
<span class="java_plain">file&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">'exim.conf'</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;notify&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_type">Service</span><span class="java_separator">[</span><span class="java_literal">'exim'</span><span class="java_separator">],</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span>
<span class="java_plain"></span>
<span class="java_plain">service&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">'exim'</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span></code></pre>
<p>which is equivalent to</p> 
<pre class=" code"><code><span class="java_type">Package</span><span class="java_separator">[</span><span class="java_literal">'exim'</span><span class="java_separator">]</span><span class="java_plain">&nbsp;</span><span class="java_operator">-&gt;</span><span class="java_plain">&nbsp;</span><span class="java_type">File</span><span class="java_separator">[</span><span class="java_literal">'exim.conf'</span><span class="java_separator">]</span><span class="java_plain">&nbsp;</span><span class="java_operator">~&gt;</span><span class="java_plain">&nbsp;</span><span class="java_type">Service</span><span class="java_separator">[</span><span class="java_literal">'exim'</span><span class="java_separator">]</span><span class="java_plain"></span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Managing dependencies - require | subscribe</h2>
       
                            
     <p>The previous example can be expressed using the alternative reverse metaparameters:</p> 
<pre class=" code"><code><span class="java_keyword">package</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">'exim'</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span>
<span class="java_plain"></span>
<span class="java_plain">file&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">'exim.conf'</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;require&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_type">Package</span><span class="java_separator">[</span><span class="java_literal">'exim'</span><span class="java_separator">],</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span>
<span class="java_plain"></span>
<span class="java_plain">service&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">'exim'</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;subscribe&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_type">File</span><span class="java_separator">[</span><span class="java_literal">'exim.conf'</span><span class="java_separator">],</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span></code></pre>
<p>which can also be expressed like:</p> 
<pre class=" code"><code><span class="java_type">Service</span><span class="java_separator">[</span><span class="java_literal">'exim'</span><span class="java_separator">]</span><span class="java_plain">&nbsp;</span><span class="java_operator">&lt;~</span><span class="java_plain">&nbsp;</span><span class="java_type">File</span><span class="java_separator">[</span><span class="java_literal">'exim.conf'</span><span class="java_separator">]</span><span class="java_plain">&nbsp;</span><span class="java_operator">&lt;-</span><span class="java_plain">&nbsp;</span><span class="java_type">Package</span><span class="java_separator">[</span><span class="java_literal">'exim'</span><span class="java_separator">]</span><span class="java_plain"></span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Conditionals</h2>
       
                            
     <p><abbr title="Puppet automation tool">Puppet</abbr> provides different constructs to manage conditionals inside manifests:</p>
<p><strong>Selectors</strong> allows to set the value of a variable or an argument inside a resource declaration according to the value of another variable.<br />Selectors therefore just returns values and are not used to manage conditionally entire blocks of code.</p>
<p><strong>case statements</strong> are used to execute different blocks of code according to the values of a variable. It's possible to have a default block for unmatched entries.<br />Case statements are NOT used inside resource declarations.</p>
<p><strong>if elsif else</strong> conditionals, like case, are used to execute different blocks of code and can't be used inside resources declarations.<br />We can can use any of <abbr title="Puppet automation tool">Puppet</abbr>'s comparison expressions and we can combine more than one for complex patterns matching.</p>
<p><strong>unless</strong> is somehow the opposite of <strong>if</strong>. It evaluates a boolean condition and if it's <em>false</em> it executes a block of code. It doesn't have elsif / else clauses.</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Sample: Assign a variable value</h2>
       
                            
     <h4>Selector for variable's assignement</h4> 
<pre class=" code"><code><span class="java_plain">$package_name&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;$osfamily&nbsp;</span><span class="java_operator">?</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_literal">'RedHat'</span><span class="java_plain">&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'httpd'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_literal">'Debian'</span><span class="java_plain">&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'apache2'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">default</span><span class="java_plain">&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;undef</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;</span><span class="java_separator">}</span><span class="java_plain"></span></code></pre> 
<h4>case</h4> 
<pre class=" code"><code><span class="java_keyword">case</span><span class="java_plain">&nbsp;$</span><span class="java_operator">::</span><span class="java_plain">osfamily&nbsp;</span><span class="java_separator">{</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_literal">'Debian'</span><span class="java_operator">:</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;$package_name&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">'apache2'</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_literal">'RedHat'</span><span class="java_operator">:</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;$package_name&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">'httpd'</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">default</span><span class="java_operator">:</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;notify&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Operating&nbsp;system&nbsp;$::operatingsystem&nbsp;not&nbsp;supported&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;</span><span class="java_separator">}</span><span class="java_plain"></span></code></pre> 
<h4>if elsif else</h4> 
<pre class=" code"><code><span class="java_keyword">if</span><span class="java_plain">&nbsp;$</span><span class="java_operator">::</span><span class="java_plain">osfamily&nbsp;</span><span class="java_operator">==</span><span class="java_plain">&nbsp;</span><span class="java_literal">'Debian'</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;$package_name&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">'apache2'</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;</span><span class="java_separator">}</span><span class="java_plain">&nbsp;elsif&nbsp;$</span><span class="java_operator">::</span><span class="java_plain">osfamily&nbsp;</span><span class="java_operator">==</span><span class="java_plain">&nbsp;</span><span class="java_literal">'RedHat'</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;$package_name&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">'httpd'</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;</span><span class="java_separator">}</span><span class="java_plain">&nbsp;</span><span class="java_keyword">else</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;notify&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Operating&nbsp;system&nbsp;$::operatingsystem&nbsp;not&nbsp;supported&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;</span><span class="java_separator">}</span><span class="java_plain"></span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Comparing strings: operators</h2>
       
                            
     <p><abbr title="Puppet automation tool">Puppet</abbr> supports some common comparison operators: <code><span class="java_operator">==</span><span class="java_plain">&nbsp;</span><span class="java_operator">!=</span><span class="java_plain">&nbsp;</span><span class="java_operator">&lt;</span><span class="java_plain">&nbsp;</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;</span><span class="java_operator">&lt;=</span><span class="java_plain">&nbsp;</span><span class="java_operator">&gt;=</span><span class="java_plain">&nbsp;</span><span class="java_operator">=~</span><span class="java_plain">&nbsp;</span><span class="java_operator">!~</span><span class="java_plain"></span></code> and the somehow less common <code><span class="java_plain">in</span></code></p> 
<pre class=" code"><code><span class="java_keyword">if</span><span class="java_plain">&nbsp;$</span><span class="java_operator">::</span><span class="java_plain">osfamily&nbsp;</span><span class="java_operator">==</span><span class="java_plain">&nbsp;</span><span class="java_literal">'Debian'</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_separator">[</span><span class="java_plain">&nbsp;</span><span class="java_separator">...</span><span class="java_plain">&nbsp;</span><span class="java_separator">]</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span><span class="java_plain"></span>
<span class="java_plain"></span>
<span class="java_plain">&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;$</span><span class="java_operator">::</span><span class="java_plain">kernel&nbsp;</span><span class="java_operator">!=</span><span class="java_plain">&nbsp;</span><span class="java_literal">'Linux'</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_separator">[</span><span class="java_plain">&nbsp;</span><span class="java_separator">...</span><span class="java_plain">&nbsp;</span><span class="java_separator">]</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span><span class="java_plain"></span>
<span class="java_plain"></span>
<span class="java_plain">&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;$</span><span class="java_operator">::</span><span class="java_plain">uptime_days&nbsp;</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">365</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_separator">[</span><span class="java_plain">&nbsp;</span><span class="java_separator">...</span><span class="java_plain">&nbsp;</span><span class="java_separator">]</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span><span class="java_plain"></span>
<span class="java_plain"></span>
<span class="java_plain">&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;$</span><span class="java_operator">::</span><span class="java_plain">operatingsystemrelease&nbsp;</span><span class="java_operator">&lt;=</span><span class="java_plain">&nbsp;</span><span class="java_literal">6</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_separator">[</span><span class="java_plain">&nbsp;</span><span class="java_separator">...</span><span class="java_plain">&nbsp;</span><span class="java_separator">]</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span><span class="java_plain"></span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Comparing strings: in operator and combinations</h2>
       
                            
     <h2>in operator</h2>
<p>The in operator checks if a string present in another string, an array or in the keys of an hash</p> 
<pre class=" code"><code><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_literal">'64'</span><span class="java_plain">&nbsp;in&nbsp;$</span><span class="java_operator">::</span><span class="java_plain">architecture</span>
<span class="java_plain"></span>
<span class="java_plain">&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;$monitor_tool&nbsp;in&nbsp;</span><span class="java_separator">[</span><span class="java_plain">&nbsp;</span><span class="java_literal">'nagios'</span><span class="java_plain">&nbsp;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">'icinga'</span><span class="java_plain">&nbsp;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">'sensu'</span><span class="java_plain">&nbsp;</span><span class="java_separator">]</span><span class="java_plain"></span></code></pre> 
<h2>Expressions combinations</h2>
<p>It's possible to combine multiple comparisons with <strong>and</strong> and <strong>or</strong></p> 
<pre class=" code"><code><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">$</span><span class="java_operator">::</span><span class="java_plain">osfamily&nbsp;</span><span class="java_operator">==</span><span class="java_plain">&nbsp;</span><span class="java_literal">'RedHat'</span><span class="java_separator">)</span><span class="java_plain"></span>
<span class="java_plain">and&nbsp;</span><span class="java_separator">(</span><span class="java_plain">$</span><span class="java_operator">::</span><span class="java_plain">operatingsystemrelease&nbsp;</span><span class="java_operator">==</span><span class="java_plain">&nbsp;</span><span class="java_literal">'5'</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_separator">[</span><span class="java_plain">&nbsp;</span><span class="java_separator">...</span><span class="java_plain">&nbsp;</span><span class="java_separator">]</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span>
<span class="java_plain"></span>
<span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">$</span><span class="java_operator">::</span><span class="java_plain">osfamily&nbsp;</span><span class="java_operator">==</span><span class="java_plain">&nbsp;</span><span class="java_literal">'Debian'</span><span class="java_separator">)</span><span class="java_plain">&nbsp;or&nbsp;</span><span class="java_separator">(</span><span class="java_plain">$</span><span class="java_operator">::</span><span class="java_plain">osfamily&nbsp;</span><span class="java_operator">==</span><span class="java_plain">&nbsp;</span><span class="java_literal">'RedHat'</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_separator">[</span><span class="java_plain">&nbsp;</span><span class="java_separator">...]</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Exported resources</h2>
       
                            
     <p>When we need to provide to an host informations about resources present in another host, we need <strong>exported resources</strong>: resources declared in the catalog of a node (based on its facts and variables) but applied (collected) on another node.</p>
<p>Resources are declared with the special @@ notation which marks them as exported so that they are not applied to the node where they are declared:</p> 
<pre class=" code"><code><span class="java_plain">@@host&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;$</span><span class="java_operator">::</span><span class="java_plain">fqdn</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;ip&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;$</span><span class="java_operator">::</span><span class="java_plain">ipaddress</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span>
<span class="java_plain"></span>
<span class="java_plain">@@concat</span><span class="java_operator">::</span><span class="java_plain">fragment&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;balance-fe-${::hostname}&quot;</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;target&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'/etc/haproxy/haproxy.cfg'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;content&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;server&nbsp;${::hostname}&nbsp;${::ipaddress}&nbsp;maxconn&nbsp;5000&quot;</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;tag&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;balance-fe&quot;</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span></code></pre>
<p>Once a catalog containing exported resources has been applied on a node and stored by the PuppetMaster (typically on PuppetDB), the exported resources can be collected with the spaceshift syntax (where is possible to specify search queries):</p> 
<pre class=" code"><code><span class="java_type">Host</span><span class="java_plain">&nbsp;</span><span class="java_operator">&lt;&lt;</span><span class="java_plain">&nbsp;</span><span class="java_operator">||</span><span class="java_plain">&nbsp;</span><span class="java_operator">&gt;&gt;</span><span class="java_plain"></span>
<span class="java_type">Concat</span><span class="java_operator">::</span><span class="java_type">Fragment</span><span class="java_plain">&nbsp;</span><span class="java_operator">&lt;&lt;|</span><span class="java_plain">&nbsp;tag&nbsp;</span><span class="java_operator">==</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;balance-fe&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">|&gt;&gt;</span><span class="java_plain"></span>
<span class="java_type">Sshkey</span><span class="java_plain">&nbsp;</span><span class="java_operator">&lt;&lt;|</span><span class="java_plain">&nbsp;</span><span class="java_operator">|&gt;&gt;</span><span class="java_plain"></span>
<span class="java_type">Nagios_service</span><span class="java_plain">&nbsp;</span><span class="java_operator">&lt;&lt;||&gt;&gt;</span><span class="java_plain"></span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Exported resources - Configuration</h2>
       
                            
     <p>In order to use exported resources we need to enable on the <abbr title="Puppet automation tool">Puppet</abbr> Master the <strong>storeconfigs</strong> option and specify the backend to use.<br />We can do this configuring a PuppetMaster to use PuppetDB:</p> 
<pre class=" code"><code><span class="java_plain">storeconfigs&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">true</span><span class="java_plain"></span>
<span class="java_plain">storeconfigs_backend&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;puppetdb</span></code></pre>
<p>In earlier <abbr title="Puppet automation tool">Puppet</abbr> versions storeconfigs is based on ActiveRecord, which is considerable slower.</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Modules - Overview</h2>
       
                            
     <h3>Modules structure and conventions</h3> 
<h3>Erb templates</h3> 
<h3>Patterns for modules reusability</h3> 
<h3>Principles of modules testing</h3> 
<h3>Modules documentation</h3>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Modules</h2>
       
                            
     <p>Self Contained and Distributable <em>recipes</em> contained in a directory with a predefined structure</p>
<p>Used to manage an application, system's resources, a local site or more complex structures</p>
<p>Modules must be placed in the <abbr title="Puppet automation tool">Puppet</abbr> Master's modulepath</p> 
<pre class=" code"><code><span class="java_plain">puppet&nbsp;config&nbsp;print&nbsp;modulepath</span>
<span class="java_operator">/</span><span class="java_plain">etc</span><span class="java_operator">/</span><span class="java_plain">puppet</span><span class="java_operator">/</span><span class="java_plain">modules</span><span class="java_operator">:/</span><span class="java_plain">usr</span><span class="java_operator">/</span><span class="java_plain">share</span><span class="java_operator">/</span><span class="java_plain">puppet</span><span class="java_operator">/</span><span class="java_plain">modules</span></code></pre>
<p><abbr title="Puppet automation tool">Puppet</abbr> module tool to interface with <abbr title="Puppet automation tool">Puppet</abbr> Modules Forge</p> 
<pre class=" code"><code><span class="java_plain">puppet&nbsp;help&nbsp;module</span>
<span class="java_separator">[...]</span><span class="java_plain"></span>
<span class="java_plain">ACTIONS</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;build&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Build</span><span class="java_plain">&nbsp;a&nbsp;module&nbsp;release&nbsp;</span><span class="java_keyword">package</span><span class="java_separator">.</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;changes&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Show</span><span class="java_plain">&nbsp;modified&nbsp;files&nbsp;of&nbsp;an&nbsp;installed&nbsp;module</span><span class="java_separator">.</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;generate&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Generate</span><span class="java_plain">&nbsp;boilerplate&nbsp;</span><span class="java_keyword">for</span><span class="java_plain">&nbsp;a&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;module</span><span class="java_separator">.</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;install&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Install</span><span class="java_plain">&nbsp;a&nbsp;module&nbsp;from&nbsp;the&nbsp;</span><span class="java_type">Puppet</span><span class="java_plain">&nbsp;</span><span class="java_type">Forge</span><span class="java_plain">&nbsp;or&nbsp;an&nbsp;archive</span><span class="java_separator">.</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;list&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">List</span><span class="java_plain">&nbsp;installed&nbsp;modules</span>
<span class="java_plain">&nbsp;&nbsp;search&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Search</span><span class="java_plain">&nbsp;the&nbsp;</span><span class="java_type">Puppet</span><span class="java_plain">&nbsp;</span><span class="java_type">Forge</span><span class="java_plain">&nbsp;</span><span class="java_keyword">for</span><span class="java_plain">&nbsp;a&nbsp;module</span><span class="java_separator">.</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;uninstall&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Uninstall</span><span class="java_plain">&nbsp;a&nbsp;puppet&nbsp;module</span><span class="java_separator">.</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;upgrade&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Upgrade</span><span class="java_plain">&nbsp;a&nbsp;puppet&nbsp;module</span><span class="java_separator">.</span><span class="java_plain"></span></code></pre>
<p>GitHub, also, is full of <abbr title="Puppet automation tool">Puppet</abbr> modules</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Paths of a module</h2>
       
                            
     <p>Modules have a standard structure:</p> 
<pre class=" code"><code><span class="java_plain">mysql</span><span class="java_operator">/</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;</span><span class="java_type">Main</span><span class="java_plain">&nbsp;module&nbsp;directory</span>
<span class="java_plain"></span>
<span class="java_plain">mysql</span><span class="java_operator">/</span><span class="java_plain">manifests</span><span class="java_operator">/</span><span class="java_plain">&nbsp;&nbsp;#&nbsp;</span><span class="java_type">Manifests</span><span class="java_plain">&nbsp;directory</span><span class="java_separator">.</span><span class="java_plain">&nbsp;</span><span class="java_type">Puppet</span><span class="java_plain">&nbsp;code&nbsp;here</span><span class="java_separator">.</span><span class="java_plain">&nbsp;</span><span class="java_type">Required</span><span class="java_separator">.</span><span class="java_plain"></span>
<span class="java_plain">mysql</span><span class="java_operator">/</span><span class="java_plain">lib</span><span class="java_operator">/</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;</span><span class="java_type">Plugins</span><span class="java_plain">&nbsp;directory</span><span class="java_separator">.</span><span class="java_plain">&nbsp;</span><span class="java_type">Ruby</span><span class="java_plain">&nbsp;code&nbsp;here</span>
<span class="java_plain">mysql</span><span class="java_operator">/</span><span class="java_plain">templates</span><span class="java_operator">/</span><span class="java_plain">&nbsp;&nbsp;#&nbsp;ERB&nbsp;</span><span class="java_type">Templates</span><span class="java_plain">&nbsp;directory</span>
<span class="java_plain">mysql</span><span class="java_operator">/</span><span class="java_plain">files</span><span class="java_operator">/</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;</span><span class="java_type">Static</span><span class="java_plain">&nbsp;files&nbsp;directory</span>
<span class="java_plain">mysql</span><span class="java_operator">/</span><span class="java_plain">spec</span><span class="java_operator">/</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;</span><span class="java_type">Puppet</span><span class="java_operator">-</span><span class="java_plain">rspec&nbsp;test&nbsp;directory</span>
<span class="java_plain">mysql</span><span class="java_operator">/</span><span class="java_plain">tests</span><span class="java_operator">/</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;</span><span class="java_type">Tests</span><span class="java_plain">&nbsp;</span><span class="java_operator">/</span><span class="java_plain">&nbsp;</span><span class="java_type">Usage</span><span class="java_plain">&nbsp;examples&nbsp;directory</span>
<span class="java_plain"></span>
<span class="java_plain">mysql</span><span class="java_operator">/</span><span class="java_type">Modulefile</span><span class="java_plain">&nbsp;&nbsp;#&nbsp;</span><span class="java_type">Module</span><span class="java_literal">'s&nbsp;metadata&nbsp;descriptor</span></code></pre>
<p>This layout enables useful conventions</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Modules paths conventions</h2>
       
                            
     <p>Classes and defines autoloading:</p> 
<pre class=" code"><code><span class="java_plain">include&nbsp;mysql</span>
<span class="java_plain">#&nbsp;</span><span class="java_type">Main</span><span class="java_plain">&nbsp;mysql&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;is&nbsp;placed&nbsp;in</span><span class="java_operator">:</span><span class="java_plain">&nbsp;$modulepath</span><span class="java_operator">/</span><span class="java_plain">mysql</span><span class="java_operator">/</span><span class="java_plain">manifests</span><span class="java_operator">/</span><span class="java_plain">init</span><span class="java_separator">.</span><span class="java_plain">pp</span>
<span class="java_plain"></span>
<span class="java_plain">include&nbsp;mysql</span><span class="java_operator">::</span><span class="java_plain">server</span>
<span class="java_plain">#&nbsp;</span><span class="java_type">This</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;is&nbsp;defined&nbsp;in</span><span class="java_operator">:</span><span class="java_plain">&nbsp;$modulepath</span><span class="java_operator">/</span><span class="java_plain">mysql</span><span class="java_operator">/</span><span class="java_plain">manifests</span><span class="java_operator">/</span><span class="java_plain">server</span><span class="java_separator">.</span><span class="java_plain">pp</span>
<span class="java_plain"></span>
<span class="java_plain">mysql</span><span class="java_operator">::</span><span class="java_plain">conf&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_separator">...}</span><span class="java_plain"></span>
<span class="java_plain">#&nbsp;</span><span class="java_type">This</span><span class="java_plain">&nbsp;define&nbsp;is&nbsp;defined&nbsp;in</span><span class="java_operator">:</span><span class="java_plain">&nbsp;$modulepath</span><span class="java_operator">/</span><span class="java_plain">mysql</span><span class="java_operator">/</span><span class="java_plain">manifests</span><span class="java_operator">/</span><span class="java_plain">conf</span><span class="java_separator">.</span><span class="java_plain">pp</span>
<span class="java_plain"></span>
<span class="java_plain">include&nbsp;mysql</span><span class="java_operator">::</span><span class="java_plain">server</span><span class="java_operator">::</span><span class="java_plain">ha</span>
<span class="java_plain">#&nbsp;</span><span class="java_type">This</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;is&nbsp;defined&nbsp;in</span><span class="java_operator">:</span><span class="java_plain">&nbsp;$modulepath</span><span class="java_operator">/</span><span class="java_plain">mysql</span><span class="java_operator">/</span><span class="java_plain">manifests</span><span class="java_operator">/</span><span class="java_plain">server</span><span class="java_operator">/</span><span class="java_plain">ha</span><span class="java_separator">.</span><span class="java_plain">pp</span></code></pre>
<p>Provide files based on Erb Templates (Dynamic content)</p> 
<pre class=" code"><code><span class="java_plain">content&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;template</span><span class="java_separator">(</span><span class="java_literal">'mysql/my.cnf.erb'</span><span class="java_separator">),</span><span class="java_plain"></span>
<span class="java_plain">#&nbsp;</span><span class="java_type">Template</span><span class="java_plain">&nbsp;is&nbsp;in</span><span class="java_operator">:</span><span class="java_plain">&nbsp;$modulepath</span><span class="java_operator">/</span><span class="java_plain">mysql</span><span class="java_operator">/</span><span class="java_plain">templates</span><span class="java_operator">/</span><span class="java_plain">my</span><span class="java_separator">.</span><span class="java_plain">cnf</span><span class="java_separator">.</span><span class="java_plain">erb</span></code></pre>
<p>Provide static files (Static content). Note we can't use content AND source for the same file.</p> 
<pre class=" code"><code><span class="java_plain">source&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'puppet:///modules/mysql/my.cnf'</span><span class="java_plain"></span>
<span class="java_plain">#&nbsp;</span><span class="java_type">File</span><span class="java_plain">&nbsp;is&nbsp;in</span><span class="java_operator">:</span><span class="java_plain">&nbsp;$modulepath</span><span class="java_operator">/</span><span class="java_plain">mysql</span><span class="java_operator">/</span><span class="java_plain">files</span><span class="java_operator">/</span><span class="java_plain">my</span><span class="java_separator">.</span><span class="java_plain">cnf</span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Erb templates</h2>
       
                            
     <p>Files provisioned by <abbr title="Puppet automation tool">Puppet</abbr> can be Ruby ERB templates</p>
<p>In a template all the <abbr title="Puppet automation tool">Puppet</abbr> variables (facts or user assigned) can be used :</p> 
<pre class=" code"><code><span class="java_plain">#&nbsp;</span><span class="java_type">File</span><span class="java_plain">&nbsp;managed&nbsp;by&nbsp;</span><span class="java_type">Puppet</span><span class="java_plain">&nbsp;on&nbsp;</span><span class="java_operator">&lt;%=</span><span class="java_plain">&nbsp;@fqdn&nbsp;</span><span class="java_operator">%&gt;</span><span class="java_plain"></span>
<span class="java_plain">search&nbsp;</span><span class="java_operator">&lt;%=</span><span class="java_plain">&nbsp;@domain&nbsp;</span><span class="java_operator">%&gt;</span><span class="java_plain"></span></code></pre>
<p>But also more elaborated Ruby code</p> 
<pre class=" code"><code><span class="java_operator">&lt;%</span><span class="java_plain">&nbsp;@dns_servers</span><span class="java_separator">.</span><span class="java_plain">each&nbsp;</span><span class="java_keyword">do</span><span class="java_plain">&nbsp;</span><span class="java_operator">|</span><span class="java_plain">ns</span><span class="java_operator">|</span><span class="java_plain">&nbsp;</span><span class="java_operator">%&gt;</span><span class="java_plain"></span>
<span class="java_plain">nameserver&nbsp;</span><span class="java_operator">&lt;%=</span><span class="java_plain">&nbsp;ns&nbsp;</span><span class="java_operator">%&gt;</span><span class="java_plain"></span>
<span class="java_operator">&lt;%</span><span class="java_plain">&nbsp;end&nbsp;</span><span class="java_operator">%&gt;</span><span class="java_plain"></span></code></pre>
<p>The computed template content is placed directly inside the catalog<br /> (Sourced files, instead, are retrieved from the puppetmaster during catalog application)</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Principes behind a Reusable Module</h2>
       
                            
     <p>Data Separation</p> 
<pre class=" code"><code><span class="java_operator">-</span><span class="java_plain">&nbsp;</span><span class="java_type">Configuration</span><span class="java_plain">&nbsp;data&nbsp;is&nbsp;defined&nbsp;outside&nbsp;the&nbsp;module</span>
<span class="java_operator">-</span><span class="java_plain">&nbsp;</span><span class="java_type">Module</span><span class="java_plain">&nbsp;behavior&nbsp;can&nbsp;be&nbsp;managed&nbsp;via&nbsp;parameters</span>
<span class="java_operator">-</span><span class="java_plain">&nbsp;</span><span class="java_type">Allow</span><span class="java_plain">&nbsp;module</span><span class="java_literal">'s&nbsp;extension&nbsp;and&nbsp;override&nbsp;via&nbsp;external&nbsp;data</span></code></pre>
<p>Reusability</p> 
<pre class=" code"><code><span class="java_operator">-</span><span class="java_plain">&nbsp;</span><span class="java_type">Support</span><span class="java_plain">&nbsp;different&nbsp;OS</span><span class="java_separator">.</span><span class="java_plain">&nbsp;</span><span class="java_type">Easily</span><span class="java_plain">&nbsp;allow&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;additions</span><span class="java_separator">.</span><span class="java_plain"></span>
<span class="java_operator">-</span><span class="java_plain">&nbsp;</span><span class="java_type">Customize</span><span class="java_plain">&nbsp;behavior&nbsp;without&nbsp;changing&nbsp;module&nbsp;code</span>
<span class="java_operator">-</span><span class="java_plain">&nbsp;</span><span class="java_type">Do</span><span class="java_plain">&nbsp;not&nbsp;force&nbsp;author&nbsp;idea&nbsp;on&nbsp;how&nbsp;configurations&nbsp;should&nbsp;be&nbsp;provided</span></code></pre>
<p>Standardization</p> 
<pre class=" code"><code><span class="java_operator">-</span><span class="java_plain">&nbsp;</span><span class="java_type">Follow</span><span class="java_plain">&nbsp;</span><span class="java_type">PuppetLabs</span><span class="java_plain">&nbsp;style&nbsp;guidelines&nbsp;</span><span class="java_separator">(</span><span class="java_plain">puppet</span><span class="java_operator">-</span><span class="java_plain">lint</span><span class="java_separator">)</span><span class="java_plain"></span>
<span class="java_operator">-</span><span class="java_plain">&nbsp;</span><span class="java_type">Have</span><span class="java_plain">&nbsp;coherent</span><span class="java_separator">,</span><span class="java_plain">&nbsp;predictable&nbsp;and&nbsp;intuitive&nbsp;interfaces</span>
<span class="java_operator">-</span><span class="java_plain">&nbsp;</span><span class="java_type">Provide</span><span class="java_plain">&nbsp;contextual&nbsp;documentation&nbsp;</span><span class="java_separator">(</span><span class="java_plain">puppet</span><span class="java_operator">-</span><span class="java_plain">doc</span><span class="java_separator">)</span><span class="java_plain"></span></code></pre>
<p>Interoperability</p> 
<pre class=" code"><code><span class="java_operator">-</span><span class="java_plain">&nbsp;</span><span class="java_type">Limit</span><span class="java_plain">&nbsp;cross</span><span class="java_operator">-</span><span class="java_plain">module&nbsp;dependencies</span>
<span class="java_operator">-</span><span class="java_plain">&nbsp;</span><span class="java_type">Allow</span><span class="java_plain">&nbsp;easy&nbsp;modules&nbsp;cherry&nbsp;picking</span>
<span class="java_operator">-</span><span class="java_plain">&nbsp;</span><span class="java_type">Be</span><span class="java_plain">&nbsp;self&nbsp;contained</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_keyword">do</span><span class="java_plain">&nbsp;not&nbsp;interfere&nbsp;with&nbsp;other&nbsp;modules</span><span class="java_literal">'&nbsp;resources</span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Modules reusability patterns: Template + Options hash</h2>
       
                            
     <p>Check this <a href="http://www.example42.com/2014/10/29/reusability-features-every-module-should-have/">blog post</a> for details.</p>
<p>Classes and defines should expose parameters that allow to override the used templates and set a custom hash of configurations.</p> 
<pre class=" code"><code><span class="java_keyword">class</span><span class="java_plain">&nbsp;redis&nbsp;</span><span class="java_separator">(</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;$config_file_template&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">'redis/redis.conf.erb'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;$options_hash&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">{},</span><span class="java_plain"></span>
<span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;file&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_literal">'/etc/redis/redis.conf'</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;content&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;template</span><span class="java_separator">(</span><span class="java_plain">$config_file_template</span><span class="java_separator">),</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Template + Options hash example:</h2>
       
                            
     <p>Given the previous class definition, we can configure it with this sample Hiera data, in YAML format:</p> 
<pre class=" code"><code><span class="java_operator">---</span><span class="java_plain"></span>
<span class="java_plain">redis</span><span class="java_operator">::</span><span class="java_plain">config_file_template</span><span class="java_operator">:</span><span class="java_plain">&nbsp;</span><span class="java_literal">'site/redis/redis.conf.erb'</span><span class="java_plain"></span>
<span class="java_plain">redis</span><span class="java_operator">::</span><span class="java_plain">options_hash</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;port</span><span class="java_operator">:</span><span class="java_plain">&nbsp;</span><span class="java_literal">'12312'</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;bind</span><span class="java_operator">:</span><span class="java_plain">&nbsp;</span><span class="java_literal">'0.0.0.0'</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;masterip</span><span class="java_operator">:</span><span class="java_plain">&nbsp;</span><span class="java_literal">'10.0.42.50'</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;masterport</span><span class="java_operator">:</span><span class="java_plain">&nbsp;</span><span class="java_literal">'12350'</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;slave</span><span class="java_operator">:</span><span class="java_plain">&nbsp;</span><span class="java_literal">true</span><span class="java_plain"></span></code></pre>
<p>The referenced template stays in our site module, in <code><span class="java_plain">$modulepath</span><span class="java_operator">/</span><span class="java_plain">site</span><span class="java_operator">/</span><span class="java_plain">templates</span><span class="java_operator">/</span><span class="java_plain">redis</span><span class="java_operator">/</span><span class="java_plain">redis</span><span class="java_separator">.</span><span class="java_plain">conf</span><span class="java_separator">.</span><span class="java_plain">erb</span></code> and may look like:</p> 
<pre class=" code"><code><span class="java_plain">port&nbsp;</span><span class="java_operator">&lt;%=</span><span class="java_plain">&nbsp;@options_hash</span><span class="java_separator">[</span><span class="java_literal">'port'</span><span class="java_separator">]</span><span class="java_plain">&nbsp;</span><span class="java_operator">%&gt;</span><span class="java_plain"></span>
<span class="java_plain">bind&nbsp;</span><span class="java_operator">&lt;%=</span><span class="java_plain">&nbsp;@options_hash</span><span class="java_separator">[</span><span class="java_literal">'bind'</span><span class="java_separator">]</span><span class="java_plain">&nbsp;</span><span class="java_operator">%&gt;</span><span class="java_plain"></span>
<span class="java_operator">&lt;%</span><span class="java_plain">&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;@options_hash</span><span class="java_separator">[</span><span class="java_literal">'slave'</span><span class="java_separator">]</span><span class="java_plain">&nbsp;</span><span class="java_operator">==</span><span class="java_plain">&nbsp;</span><span class="java_literal">true</span><span class="java_plain">&nbsp;</span><span class="java_operator">-%&gt;</span><span class="java_plain"></span>
<span class="java_plain">slaveof&nbsp;</span><span class="java_operator">&lt;%=</span><span class="java_plain">&nbsp;@options_hash</span><span class="java_separator">[</span><span class="java_literal">'masterip'</span><span class="java_separator">]</span><span class="java_plain">&nbsp;</span><span class="java_operator">%&gt;</span><span class="java_plain">&nbsp;</span><span class="java_operator">&lt;%=</span><span class="java_plain">&nbsp;@options_hash</span><span class="java_separator">[</span><span class="java_literal">'masterport'</span><span class="java_separator">]</span><span class="java_plain">&nbsp;</span><span class="java_operator">%&gt;</span><span class="java_plain"></span>
<span class="java_operator">&lt;%</span><span class="java_plain">&nbsp;end&nbsp;</span><span class="java_operator">-%&gt;</span><span class="java_plain"></span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Modules reusability patterns: Users override on included classes</h2>
       
                            
     <p>Sometimes modules need some prerequisites or have to manage resources related to other applications or may provide the same functionality in diffret ways.<br />Whenever this is needed, let users provide custom versions for the relevant classes.</p>
<p>This module manages the <abbr title="Puppet automation tool">Puppet</abbr> Master in a dedicated class an exposes a parameter that allows users to provide a custom class (or an alternative class eventually provided by the same module) instead of the default one.</p> 
<pre class=" code"><code><span class="java_keyword">class</span><span class="java_plain">&nbsp;puppet&nbsp;</span><span class="java_separator">(</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;$server_class&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">'::puppet::server'</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain"></span>
<span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;$server_class&nbsp;</span><span class="java_separator">{</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;include&nbsp;$server_class</span>
<span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span></code></pre>
<p>Using Hiera we ca override with:</p> 
<pre class=" code"><code><span class="java_operator">---</span><span class="java_plain"></span>
<span class="java_plain">puppet</span><span class="java_operator">::</span><span class="java_plain">server_class</span><span class="java_operator">:</span><span class="java_plain">&nbsp;</span><span class="java_literal">'::site::puppet::haserver'</span><span class="java_plain"></span></code></pre>
<p>This implies that we need to create in <code><span class="java_plain">$modulepath</span><span class="java_operator">/</span><span class="java_plain">site</span><span class="java_operator">/</span><span class="java_plain">manifests</span><span class="java_operator">/</span><span class="java_plain">puppet</span><span class="java_operator">/</span><span class="java_plain">haserver</span><span class="java_separator">.</span><span class="java_plain">pp</span></code> a class like:</p> 
<pre class=" code"><code><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_operator">::</span><span class="java_plain">site</span><span class="java_operator">::</span><span class="java_plain">puppet</span><span class="java_operator">::</span><span class="java_plain">haserver&nbsp;</span><span class="java_separator">{</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;#&nbsp;</span><span class="java_type">The</span><span class="java_plain">&nbsp;resources&nbsp;</span><span class="java_keyword">for</span><span class="java_plain">&nbsp;our&nbsp;HA&nbsp;</span><span class="java_type">Puppet</span><span class="java_plain">&nbsp;</span><span class="java_type">Master</span><span class="java_plain">&nbsp;setup&nbsp;&nbsp;</span>
<span class="java_separator">}</span><span class="java_plain"></span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Testing Modules</h2>
       
                            
     <p><abbr title="Puppet automation tool">Puppet</abbr> code testing can be done at different levels with different tools</p>
<p><strong>puppet parser validate &lt;manifest.pp&gt;</strong> - Checks the syntax of a manifest</p>
<p><strong>puppet-lint &lt;manifest.pp&gt;</strong> - A gem that checks the style of a manifest</p>
<p><strong>puppet-rspec</strong> - A gem that runs rspec unit tests on a module (Based on compiled catalog)</p>
<p><strong>cucumber-puppet</strong> - A gem that runs cucumber tests a module (Based on compiled catalog) OBSOLETE</p>
<p><strong>puppet-rspec-system</strong> - A gem that creates Vagrant VM and check for the expected results of real <abbr title="Puppet automation tool">Puppet</abbr> runs</p>
<p><strong>Beaker</strong> - A gem that runs acceptance tests on multiple Vagrant VM</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Modules documentation with Puppet Doc</h2>
       
                            
     <p>Puppetdoc generates documentation from manifests comments:</p> 
<pre class=" code"><code><span class="java_plain">$&nbsp;puppet&nbsp;doc&nbsp;</span><span class="java_separator">[</span><span class="java_operator">--</span><span class="java_plain">all</span><span class="java_separator">]</span><span class="java_plain">&nbsp;</span><span class="java_operator">--</span><span class="java_plain">mode&nbsp;rdoc&nbsp;</span><span class="java_separator">[</span><span class="java_operator">--</span><span class="java_plain">outputdir&nbsp;</span><span class="java_separator">]</span><span class="java_plain">&nbsp;</span><span class="java_separator">[</span><span class="java_operator">--</span><span class="java_plain">debug</span><span class="java_operator">|--</span><span class="java_plain">verbose</span><span class="java_separator">]</span><span class="java_plain">&nbsp;</span><span class="java_separator">[</span><span class="java_operator">--</span><span class="java_plain">trace</span><span class="java_separator">]</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">[</span><span class="java_operator">--</span><span class="java_plain">modulepath&nbsp;</span><span class="java_separator">]</span><span class="java_plain">&nbsp;</span><span class="java_separator">[</span><span class="java_operator">--</span><span class="java_plain">manifestdir&nbsp;</span><span class="java_separator">]</span><span class="java_plain">&nbsp;</span><span class="java_separator">[</span><span class="java_operator">--</span><span class="java_plain">config&nbsp;</span><span class="java_separator">]</span><span class="java_plain"></span></code></pre>
<p>Comment classes as below:</p> 
<pre class=" code"><code><span class="java_plain">#&nbsp;</span><span class="java_type">Class</span><span class="java_operator">:</span><span class="java_plain">&nbsp;apache</span>
<span class="java_plain">#</span>
<span class="java_plain">#&nbsp;</span><span class="java_type">This</span><span class="java_plain">&nbsp;module&nbsp;manages&nbsp;</span><span class="java_type">Apache</span><span class="java_plain"></span>
<span class="java_plain">#</span>
<span class="java_plain">#&nbsp;</span><span class="java_type">Parameters</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">#</span>
<span class="java_plain">#&nbsp;</span><span class="java_type">Actions</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">#</span>
<span class="java_plain">#&nbsp;</span><span class="java_type">Requires</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">#</span>
<span class="java_plain">#&nbsp;</span><span class="java_separator">[</span><span class="java_type">Remember</span><span class="java_operator">:</span><span class="java_plain">&nbsp;</span><span class="java_type">No</span><span class="java_plain">&nbsp;empty&nbsp;lines&nbsp;between&nbsp;comments&nbsp;and&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;definition</span><span class="java_separator">]</span><span class="java_plain"></span>
<span class="java_keyword">class</span><span class="java_plain">&nbsp;apache&nbsp;</span><span class="java_separator">{</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">...</span><span class="java_plain"></span>
<span class="java_separator">}</span><span class="java_plain"></span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Hiera - Overview</h2>
       
                            
     <h3>Principles behind Hiera</h3> 
<h3>Configuring hierarchies</h3> 
<h3>Hiera plugins</h3> 
<h3>Using Hiera from <abbr title="Puppet automation tool">Puppet</abbr> and the CLI</h3>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Introduction to Hiera</h2>
       
                            
     <p>Hiera is the <strong>key/value lookup tool</strong> of reference where to store <abbr title="Puppet automation tool">Puppet</abbr> user data.</p>
<p>It provides an highly customizable way to lookup for parameters values based on a custom hierarchy using many different backends for data storage.</p>
<p>It provides a command line tool <code><span class="java_plain">hiera</span></code> that we can use to interrogate direclty the Hiera data and functions to be used inside <abbr title="Puppet automation tool">Puppet</abbr> manifests: <code><span class="java_plain">hiera</span><span class="java_separator">()</span><span class="java_plain"></span></code> , <code><span class="java_plain">hiera_array</span><span class="java_separator">()</span><span class="java_plain"></span></code> , <code><span class="java_plain">hiera_hash</span><span class="java_separator">()</span><span class="java_plain"></span></code> , <code><span class="java_plain">hiera_include</span><span class="java_separator">()</span><span class="java_plain"></span></code></p>
<p>Hiera is installed by default with <abbr title="Puppet automation tool">Puppet</abbr> version 3 and is available as separated download on earlier version (<a href="http://docs.puppetlabs.com/hiera/1/installing.html">Installation instructions</a>).</p>
<p>We need Hiera only on the PuppetMaster (or on any node, if we have a masterless setup).</p>
<p>Currently version 1 is available, here is its <a href="http://docs.puppetlabs.com/hiera/1/">official documentation</a>.</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Hiera configuration: hiera.yaml</h2>
       
                            
     <p>Hiera's configuration file is in yaml format and is called <strong>hiera.yaml</strong> here we define the hierarchy we want to use and the backends where data is placed, with backend specific settings.</p>
<p>Hiera's configuration file path is different according to how it's invoked:</p> 
<h3>From the Command Line and Ruby code</h3>
<p>Default path: <code><span class="java_operator">/</span><span class="java_plain">etc</span><span class="java_operator">/</span><span class="java_plain">hiera</span><span class="java_separator">.</span><span class="java_plain">yaml</span></code></p> 
<h3>From <abbr title="Puppet automation tool">Puppet</abbr></h3>
<p>Default path for <abbr title="Puppet automation tool">Puppet</abbr> OpenSource: <code><span class="java_operator">/</span><span class="java_plain">etc</span><span class="java_operator">/</span><span class="java_plain">puppet</span><span class="java_operator">/</span><span class="java_plain">hiera</span><span class="java_separator">.</span><span class="java_plain">yaml</span></code></p>
<p>Default path for <abbr title="Puppet automation tool">Puppet</abbr> Enterprise: <code><span class="java_operator">/</span><span class="java_plain">etc</span><span class="java_operator">/</span><span class="java_plain">puppetlabs</span><span class="java_operator">/</span><span class="java_plain">puppet</span><span class="java_operator">/</span><span class="java_plain">hiera</span><span class="java_separator">.</span><span class="java_plain">yaml</span></code></p>
<p>It's good practice the symlink these alternative configuration files in order to avoid inconsistencies when using Hiera from the shell line or within <abbr title="Puppet automation tool">Puppet</abbr> manifests:</p> 
<pre class=" code"><code><span class="java_plain">ln&nbsp;</span><span class="java_operator">-</span><span class="java_plain">s&nbsp;</span><span class="java_operator">/</span><span class="java_plain">etc</span><span class="java_operator">/</span><span class="java_plain">hiera</span><span class="java_separator">.</span><span class="java_plain">yaml&nbsp;</span><span class="java_operator">/</span><span class="java_plain">etc</span><span class="java_operator">/</span><span class="java_plain">puppet</span><span class="java_operator">/</span><span class="java_plain">hiera</span><span class="java_separator">.</span><span class="java_plain">yaml</span></code></pre> 
<h2>Default configuration</h2>
<p>By default Hiera does not provide a configuration file. The default settings are equivalent to this:</p> 
<pre class=" code"><code><span class="java_operator">---</span><span class="java_plain"></span>
<span class="java_operator">:</span><span class="java_plain">backends</span><span class="java_operator">:</span><span class="java_plain">&nbsp;yaml</span>
<span class="java_operator">:</span><span class="java_plain">yaml</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;</span><span class="java_operator">:</span><span class="java_plain">datadir</span><span class="java_operator">:</span><span class="java_plain">&nbsp;</span><span class="java_operator">/</span><span class="java_plain">var</span><span class="java_operator">/</span><span class="java_plain">lib</span><span class="java_operator">/</span><span class="java_plain">hiera</span>
<span class="java_operator">:</span><span class="java_plain">hierarchy</span><span class="java_operator">:</span><span class="java_plain">&nbsp;common</span>
<span class="java_operator">:</span><span class="java_plain">logger</span><span class="java_operator">:</span><span class="java_plain">&nbsp;console</span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Hiera Backends</h2>
       
                            
     <p>One powerful feature of Hiera is that the actual key-value data can be retrieved from different backends.</p>
<p>With the <code><span class="java_operator">:</span><span class="java_plain">backends</span></code> global configuration we define which backends to use, then, for each used backend we can specify backend specific settings.</p> 
<h3>Build it backends:</h3>
<p><strong>yaml</strong> - Data is stored in yaml files (in the <code><span class="java_operator">:</span><span class="java_plain">datadir</span></code> directory)</p>
<p><strong>json</strong> - Data is stored in json files (in the <code><span class="java_operator">:</span><span class="java_plain">datadir</span></code> directory)</p>
<p><strong>puppet</strong> - Data is defined in <abbr title="Puppet automation tool">Puppet</abbr> (in the <code><span class="java_operator">:</span><span class="java_plain">datasouce</span></code> class)</p> 
<h3>Extra backends:</h3>
<p>Many additional backends are available, the most interesting ones are:</p>
<p><a href="https://github.com/crayfishx/hiera-gpg"><strong>gpg</strong></a> - Data is stored in GPG encripted yaml files</p>
<p><a href="https://github.com/crayfishx/hiera-http"><strong>http</strong></a> - Data is retrieved from a REST service</p>
<p><a href="https://github.com/crayfishx/hiera-mysql"><strong>mysql</strong></a> - Data is retrieved from a Mysql database</p>
<p><a href="https://github.com/reliantsecurity/hiera-redis"><strong>redis</strong></a> - Data is retrieved from a Redis database</p> 
<h3>Custom backends</h3>
<p>It's relatively easy to write custom backends for Hiera. Here are some <a href="http://docs.puppetlabs.com/hiera/1/custom_backends.html">development instructions</a></p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Hierarchies</h2>
       
                            
     <p>With the <code><span class="java_operator">:</span><span class="java_plain">hierarchy</span></code> global setting we can define a string or an array of data sources which are checked in order, from top to bottom.</p>
<p>When the same key is present on different data sources by default is chosen the top one. We can override this setting with the <code><span class="java_operator">:</span><span class="java_plain">merge_behavior</span></code> global configuration. Check <a href="http://docs.puppetlabs.com/hiera/1/lookup_types.html#deep-merging-in-hiera--120">this page</a> for details.</p>
<p>In hierarchies we can interpolate variables with the %{} notation (variables interpolation is possible also in other parts of hiera.yaml and in the same data sources).</p>
<p>This is an example Hierarchy:</p> 
<pre class=" code"><code><span class="java_operator">---</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">:</span><span class="java_plain">hierarchy</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">-</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;nodes/%{::clientcert}&quot;</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">-</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;roles/%{::role}&quot;</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">-</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;%{::osfamily}&quot;</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">-</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;%{::environment}&quot;</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">-</span><span class="java_plain">&nbsp;common</span></code></pre>
<p>Note that the referenced variables should be expressed with their fully qualified name. They are generally facts or <abbr title="Puppet automation tool">Puppet</abbr>'s top scope variables (in the above example, <strong>$::role</strong> is not a standard fact, but is generally useful to have it (or a similar variable that identifies the kind of server) in our hierarchy).</p>
<p>If we have more backends, for each backend is evaluated the full hierarchy.</p>
<p>We can find some real world hierarchies samples in this <a href="https://groups.google.com/forum/?hl=it#!topic/puppet-users/cCfimbolUio"><abbr title="Puppet automation tool">Puppet</abbr> Users Group post</a></p>
<p>More information on hierarchies <a href="http://docs.puppetlabs.com/hiera/1/hierarchy.html">here</a>.</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Using Hiera in Puppet</h2>
       
                            
     <p>The data stored in Hiera can be retrieved by the PuppetMaster while compiling the catalog using the hiera() function.</p>
<p>In our manifests we can have something like this:</p> 
<pre class=" code"><code><span class="java_plain">$my_dns_servers&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;hiera</span><span class="java_separator">(</span><span class="java_literal">&quot;dns_servers&quot;</span><span class="java_separator">)</span><span class="java_plain"></span></code></pre>
<p>Which assigns to the variable <strong><em>$my_dns_servers</em></strong> (can have any name) the top value retrieved by Hiera for the key <strong><em>dns_servers</em></strong></p>
<p>We may prefer, in some cases, to retrieve all the values retrieved in the hierarchy's data sources of a given key and not the first use, use hiera_array() for that.</p> 
<pre class=" code"><code><span class="java_plain">$my_dns_servers&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;hiera_array</span><span class="java_separator">(</span><span class="java_literal">&quot;dns_servers&quot;</span><span class="java_separator">)</span><span class="java_plain"></span></code></pre>
<p>If we expect an hash as value for a given key we can use the hiera() function to retrieve the top value found or hiera_hash to merge all the found values in a single hash:</p> 
<pre class=" code"><code><span class="java_plain">$openssh_settings&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;hiera_hash</span><span class="java_separator">(</span><span class="java_literal">&quot;openssh_settings&quot;</span><span class="java_separator">)</span><span class="java_plain"></span></code></pre> 
<h3>Extra parameters</h3>
<p>All these hiera functions may receive additional parameters:</p>
<p>Second argument: <strong>default</strong> value if no one is found</p>
<p>Third argument: <strong>override</strong> with a custom data source added at the top of the configured hierarchy</p> 
<pre class=" code"><code><span class="java_plain">$my_dns_servers&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;hiera</span><span class="java_separator">(</span><span class="java_literal">&quot;dns_servers&quot;</span><span class="java_separator">,</span><span class="java_literal">&quot;8.8.8.8&quot;</span><span class="java_separator">,</span><span class="java_literal">&quot;$country&quot;</span><span class="java_separator">)</span><span class="java_plain"></span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Puppet 3 data bindings</h2>
       
                            
     <p>With <abbr title="Puppet automation tool">Puppet</abbr> 3 Hiera is shipped directly with <abbr title="Puppet automation tool">Puppet</abbr> and an automatic hiera lookup is done for each class' parameter using the key <strong>$class::$argument</strong>: this functionality is called data bindings or automatic parameter lookup.</p>
<p>For example in a class definition like:</p> 
<pre class=" code"><code><span class="java_keyword">class</span><span class="java_plain">&nbsp;openssh&nbsp;</span><span class="java_separator">(</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;template&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;undef</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_separator">.</span><span class="java_plain">&nbsp;</span><span class="java_separator">.</span><span class="java_plain">&nbsp;</span><span class="java_separator">.</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span><span class="java_plain"></span></code></pre>
<p><abbr title="Puppet automation tool">Puppet</abbr> 3 automatically looks for the Hiera key openssh::template if no value is explitely set when declaring the class.</p>
<p>To emulate a similar behaviour on pre <abbr title="Puppet automation tool">Puppet</abbr> 3 we should write something like:</p> 
<pre class=" code"><code><span class="java_keyword">class</span><span class="java_plain">&nbsp;openssh&nbsp;</span><span class="java_separator">(</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;template&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;hiera</span><span class="java_separator">(</span><span class="java_literal">&quot;openssh::template&quot;</span><span class="java_separator">),</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_separator">.</span><span class="java_plain">&nbsp;</span><span class="java_separator">.</span><span class="java_plain">&nbsp;</span><span class="java_separator">.</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span><span class="java_plain"></span></code></pre>
<p>If a default value is set for an argument that value is used only when user has not explicitly declared value for that argument and Hiera automatic lookup for that argument doesn't return any value.</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Using hiera from the command line</h2>
       
                            
     <p>Hiera can be invoken via the command line to interrogate the given key's value:</p> 
<pre class=" code"><code><span class="java_plain">hiera&nbsp;dns_servers</span></code></pre>
<p>This will return the default value as no node's specific information is provided. More useful is to provide the whole facts' yaml of a node, so that the returned value can be based on the dynamic values of the hierarchy.<br />On the Pupppet Masters the facts of all the managed clients are collected in $vardir/yaml/facts so this is the best place to see how Hiera evaluates keys for different clients:</p> 
<pre class=" code"><code><span class="java_plain">hiera&nbsp;dns_servers&nbsp;</span><span class="java_operator">--</span><span class="java_plain">yaml&nbsp;</span><span class="java_operator">/</span><span class="java_plain">var</span><span class="java_operator">/</span><span class="java_plain">lib</span><span class="java_operator">/</span><span class="java_plain">puppet</span><span class="java_operator">/</span><span class="java_plain">yaml</span><span class="java_operator">/</span><span class="java_plain">facts</span><span class="java_operator">/&lt;</span><span class="java_plain">node</span><span class="java_operator">&gt;</span><span class="java_separator">.</span><span class="java_plain">yaml</span></code></pre>
<p>We can also pass variables useful to test the hierarchy, directly from the command line:</p> 
<pre class=" code"><code><span class="java_plain">hiera&nbsp;ntp_servers&nbsp;operatingsystem</span><span class="java_operator">=</span><span class="java_type">Centos</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;hiera&nbsp;ntp_servers&nbsp;operatingsystem</span><span class="java_operator">=</span><span class="java_type">Centos</span><span class="java_plain">&nbsp;hostname</span><span class="java_operator">=</span><span class="java_plain">jenkins</span></code></pre>
<p>To have a deeper insight of Hiera operations use the debug (-d) option:</p> 
<pre class=" code"><code><span class="java_plain">hiera&nbsp;dns_servers&nbsp;</span><span class="java_operator">-</span><span class="java_plain">d</span></code></pre>
<p>To make an hiera array lookup (equivalent to hiera_array()):</p> 
<pre class=" code"><code><span class="java_plain">hiera&nbsp;dns_servers&nbsp;</span><span class="java_operator">-</span><span class="java_plain">a</span></code></pre>
<p>To make an hiera hash lookup (equivalent to hiera_hash()):</p> 
<pre class=" code"><code><span class="java_plain">hiera&nbsp;openssh</span><span class="java_operator">::</span><span class="java_plain">settings&nbsp;</span><span class="java_operator">-</span><span class="java_plain">h</span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Puppet architectures - Overview</h2>
       
                            
     <h3>The Components of a <abbr title="Puppet automation tool">Puppet</abbr> architecture</h3> 
<h3>Where to define classes</h3> 
<h3>Where to define parameters</h3> 
<h3>Where to place files</h3> 
<h3><abbr title="Puppet automation tool">Puppet</abbr> security</h3>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Components of a Puppet architecture</h2>
       
                            
     <h3>Tasks we deal with</h3>
<p>Definition of the <strong>classes</strong> to be included in each node</p>
<p>Definition of the <strong>parameters</strong> to use for each node</p>
<p>Definition of the configuration <strong>files</strong> provided to the nodes</p> 
<h3>Components</h3>
<p><strong>/etc/puppet/manifests/site.pp</strong> - The default manifests loaded by the Master</p>
<p><strong>ENC</strong> - The (optional) Enternal Node Classifier</p>
<p><strong>ldap</strong> - (Optional) LDAP backend</p>
<p><strong>Hiera</strong> - Data key-value backend</p>
<p><strong>Public modules</strong> - Public shared modules</p>
<p><strong>Site modules</strong> - Local custom modules</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Where to define classes</h2>
       
                            
     <p>The classes to include in each node can be defined on:</p>
<p><strong>/etc/puppet/manifests/site.pp</strong> - Top or Node scope variables</p>
<p><strong>ENC</strong> - Under the classes key in the provided YAML</p>
<p><strong>ldap</strong> - puppetClass attribute</p>
<p><strong>Hiera</strong> - Via the <code><span class="java_plain">hiera_include</span><span class="java_separator">()</span><span class="java_plain"></span></code> function</p>
<p><strong>Site modules</strong> - In roles and profiles or other grouping classes</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Where to define parameters</h2>
       
                            
     <p>The classes to include in each node can be defined on:</p>
<p><strong>/etc/puppet/manifests/site.pp</strong> - Under the node statement</p>
<p><strong>ENC</strong> - Following the ENC logic</p>
<p><strong>ldap</strong> - puppetVar attribute</p>
<p><strong>Hiera</strong> - Via the <code><span class="java_plain">hiera</span><span class="java_separator">()</span><span class="java_plain"></span></code>, <code><span class="java_plain">hiera_hash</span><span class="java_separator">()</span><span class="java_plain"></span></code>, <code><span class="java_plain">hiera_array</span><span class="java_separator">()</span><span class="java_plain"></span></code> functions of <abbr title="Puppet automation tool">Puppet</abbr> 3 Data Bindings</p>
<p><strong>Shared modules</strong> - OS related settings</p>
<p><strong>Site modules</strong> - Custom and logical settings</p>
<p><strong>Facts</strong> - Facts calculated on the client</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Where to define files</h2>
       
                            
     <p><strong>Shared modules</strong> - Default templates populated via module's params</p>
<p><strong>Site modules</strong> - All custom static files and templates</p>
<p><strong>Hiera</strong> - Via the <strong>hiera-file</strong> plugin</p>
<p><strong>Fileserver</strong> custom mount points</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Code workflow management</h2>
       
                            
     <p><abbr title="Puppet automation tool">Puppet</abbr> code should stay under a SCM (Git, Subversion, Mercurial... whatever )</p>
<p>We must be able to test the code before committing to production</p>
<p>Testing <abbr title="Puppet automation tool">Puppet</abbr> code syntax is easy, testing its effects is not</p>
<p>Different testing methods for different purposes</p>
<p>Different code workflow options</p>
<p>Recommended: Couple <abbr title="Puppet automation tool">Puppet</abbr> environments with code branches <a href="http://puppetlabs.com/blog/git-workflow-and-puppet-environments/">More info</a></p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Puppet Security considerations</h2>
       
                            
     <p>Client / Server communications are encrypted with SSL x509 certificates<br /> By default the CA on the PuppetMaster requires manual signing of certificate requests</p> 
<pre class=" code"><code><span class="java_plain">#&nbsp;</span><span class="java_type">In</span><span class="java_plain">&nbsp;puppet</span><span class="java_separator">.</span><span class="java_plain">conf&nbsp;under&nbsp;</span><span class="java_separator">[</span><span class="java_plain">master</span><span class="java_separator">]</span><span class="java_plain">&nbsp;section</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_plain">autosign&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">false</span><span class="java_plain"></span></code></pre>
<p>On the <abbr title="Puppet automation tool">Puppet</abbr> Master (as unprivileged user) runs a service that must be reached by every node (port 8140 TCP)</p>
<p>On the Client <abbr title="Puppet automation tool">Puppet</abbr> runs a root but does not expose a public service</p>
<p>Sensitive data might be present in the catalog and in reports</p>
<p>Sensitive data might be present in the puppet code (Propagated under a SCM)</p>
<p><a href="http://www.puppetlas.com/security">Security advisories</a></p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>PuppetDB - Overview</h2>
       
                            
     <h3>What PuppetDB does</h3> 
<h3>Installation and configuration</h3> 
<h3><abbr title="Application Programming Interface">API</abbr> and query language</h3> 
<h3>The puppetdbquery module</h3>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Introduction to PuppetDB</h2>
       
                            
     <p>PuppetDB is a &quot;fast, scalable and reliable&quot; data warehouse for <abbr title="Puppet automation tool">Puppet</abbr>.</p>
<p>It saves data generated by <abbr title="Puppet automation tool">Puppet</abbr>: nodes' <strong>facts</strong>, <strong>catalogs</strong> and <strong>reports</strong>.</p>
<p>It can also work as a performant backend for <strong>exported resources</strong> being a recommended alternative to the older ActiveRecord storeconfigs interface.</p>
<p>It provides a faster backend also for <abbr title="Puppet automation tool">Puppet</abbr>'s <strong>Inventory Service</strong>.</p>
<p>PuppetDB is <a href="https://github.com/puppetlabs/puppetdb">opensource</a>, written in Clojure (it requires &gt;= <abbr title="&lt;abbr title=&quot;Java programming langauge&quot;&gt;Java&lt;/abbr&gt; Development Kit">JDK</abbr> 1.6 and PuppetMasters with <abbr title="Puppet automation tool">Puppet</abbr> &gt;= 2.7.12), and is delivered as an autonomous software.</p>
<p>The best source from where to retrieve it are the official <a href="http://docs.puppetlabs.com/guides/puppetlabs_package_repositories.html#open-source-repositories">Puppetlabs repositories</a>.</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>PuppetDB installation</h2>
       
                            
     <p>For a complete overview of the installation process check the official documentation and choose between installatio from <a href="http://docs.puppetlabs.com/puppetdb/latest/install_via_module.html">puppetdb module</a> or from <a href="http://docs.puppetlabs.com/puppetdb/latest/install_from_packages.html">packages</a>.</p>
<p>PuppetDB can persist data either on an embedded HSQLDB database or on PostgreSQL.<br />The latter is definitively recommended on production environment where there are a few dozens of servers or more.</p>
<p>The configuration files are:</p> 
<pre><code class="/etc/sysconfig/puppetdb``` (```/etc/default/puppetdb``` on Debian) is the init script configuration file, here we can set JAVA settings like JAVA_ARGS or JAVA_BIN"><br /><br />```/etc/puppetdb/conf.d/``` is the configuration directory, here we may have different .ini files where to configure **[global]** settings, **[database]** backends, **[command-processing]** options, **[jetty]** parameters for HTTP connections and **[repl]** settings for remote runtime configurations (used for development/debugging).


</code></pre>
<p><code><span class="java_operator">/</span><span class="java_plain">etc</span><span class="java_operator">/</span><span class="java_plain">puppet</span><span class="java_operator">/</span><span class="java_plain">puppetdb</span><span class="java_separator">.</span><span class="java_plain">conf</span></code> is the configuration file for <strong><abbr title="Puppet automation tool">Puppet</abbr></strong> with the settings to be used by the PuppetDB terminus</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>PuppetDB console and tools</h2>
       
                            
     <h4>Integrated console: Anaylize PuppetDB performance</h4>
<p>PuppetDB provides a performances dashboard out of the box, we can use it to check how the software is working: <strong><a href="http://&lt;puppetdb.server">http://
   <puppetdb.server<>
    :8080/dashboard/
   </puppetdb.server<></a></strong><a href="http://&lt;puppetdb.server">.<br />This is integral part of the PuppetDB software.</a></p>
<a href="http://&lt;puppetdb.server"> <h4><abbr title="Puppet automation tool">Puppet</abbr> Board: Query PuppetDB from the web</h4></a>
<p><a>A nice frontend that allows interrogation of the PuppetDB from the web is </a><a href="https://github.com/nedap/puppetboard">PuppetBoard</a>.<br />This software is contributed from the community.</p> 
<h4>Puppetdbquery module: Query PuppetDB from <abbr title="Puppet automation tool">Puppet</abbr> manifests</h4>
<p>An incredibly useful module that provides faces, functions and hiera backends that work with PuppetDB is the <a href="https://github.com/dalen/puppet-puppetdbquery">puppetdbquery module</a>. We can install it also from the Forge:</p> 
<pre class=" code"><code><span class="java_plain">puppet&nbsp;module&nbsp;install&nbsp;dalen</span><span class="java_operator">-</span><span class="java_plain">puppetdbquery</span></code></pre>
<p>This software is contributed from the community (and is becoming a standard de facto for PuppetDB querying inside <abbr title="Puppet automation tool">Puppet</abbr> modules).</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>PuppetDB API</h2>
       
                            
     <p>PuppetDB exposes an <a href="http://docs.puppetlabs.com/puppetdb/latest/api/">HTTP <abbr title="Application Programming Interface">API</abbr></a> that uses a Command/Query Responsibility Separation (CQRS) pattern:</p> 
<h4>REST for reading</h4>
<p>A standard REST <abbr title="Application Programming Interface">API</abbr> is used to query data.</p>
<p>The current (<abbr title="Application Programming Interface">API</abbr> v3) available endpoints are: <code><span class="java_plain">metrics</span></code>, <code><span class="java_plain">fact</span><span class="java_operator">-</span><span class="java_plain">names</span></code>, <code><span class="java_plain">facts</span></code>, <code><span class="java_plain">nodes</span></code>, <code><span class="java_plain">resources</span></code>, <code><span class="java_plain">reports</span></code>, <code><span class="java_plain">events</span></code>, <code><span class="java_plain">event</span><span class="java_operator">-</span><span class="java_plain">counts</span></code>, <code><span class="java_plain">aggregate</span><span class="java_operator">-</span><span class="java_plain">event</span><span class="java_operator">-</span><span class="java_plain">counts</span></code>, <code><span class="java_plain">server</span><span class="java_operator">-</span><span class="java_plain">time</span></code></p> 
<h4>COMMANDS for writing</h4>
<p>Explicit <strong>commands</strong> are used (via HTTP using the /commands/ URL) used to populate and modify data.</p>
<p>The current <a href="http://docs.puppetlabs.com/puppetdb/latest/api/commands.html"><strong>commands</strong></a> are: <code><span class="java_plain">replace&nbsp;catalog</span></code>, <code><span class="java_plain">replace&nbsp;facts</span></code>, <code><span class="java_plain">deactivate&nbsp;node</span></code>, <code><span class="java_plain">store&nbsp;report</span></code>.</p> 
<h3><abbr title="Application Programming Interface">API</abbr> versions</h3>
<p>There are different versions of the APIs as they evolve with PuppetDB versions.</p>
<p>As October 2013, Version 1 of the <abbr title="Application Programming Interface">API</abbr> is deprecated, Version 2 and 3 (the latter adds new endpoints and is recommended) are both supported.</p>
<p>We can access a specific version of the <abbr title="Application Programming Interface">API</abbr> using the relevant prefix:</p> 
<pre class=" code"><code><span class="java_plain">http</span><span class="java_separator">[</span><span class="java_plain">s</span><span class="java_separator">]</span><span class="java_operator">:</span><span class="java_comment">//puppetdb.server/v#/&lt;endpoint&gt;/[NAME]/[VALUE][?query=&lt;QUERY&nbsp;STRING&gt;]</span></code></pre> 
<h3>Query language</h3>
<p>Queries to the REST endpoints can define search scope and limitations for the given endpoint. The query are sent as an &quot;URL-encoded JSON array in prefix notation&quot;. Check the online <a href="http://docs.puppetlabs.com/puppetdb/latest/api/query/tutorial.html">tutorial</a> for details.</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Using Puppetdbquery module</h2>
       
                            
     <p>The <a href="https://github.com/dalen/puppet-puppetdbquery">PuppetDbQueryModule</a> is developed by a community member, Erik Dalen, and is the most used and useful module available to work with PuppetDB: it provides command lines tools (as <abbr title="Puppet automation tool">Puppet</abbr> Faces), functions to query PuppetDB and a PuppetDB based Hiera backend.</p> 
<h2>Query format</h2>
<p>All the queries we can do with this module are in the format</p> 
<pre class=" code"><code><span class="java_type">Type</span><span class="java_separator">[</span><span class="java_type">Name</span><span class="java_separator">]{</span><span class="java_plain">attribute1</span><span class="java_operator">=</span><span class="java_plain">foo&nbsp;and&nbsp;attribute2</span><span class="java_operator">=</span><span class="java_plain">bar</span><span class="java_separator">}</span><span class="java_plain"></span></code></pre>
<p>by default they are made on normal resources, use the @@ prefix to query exported resources.</p>
<p>The comparison operators are: <strong>=</strong>, <strong>!=</strong>, <strong>&gt;</strong>, <strong>&lt;</strong> and <strong>~</strong></p>
<p>The expressions can be combined with <strong>and</strong>, <strong>not</strong> and <strong>or</strong></p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Using Puppetdbquery module</h2>
       
                            
     <h2>Command line</h2>
<p>The module introduces, as a <abbr title="Puppet automation tool">Puppet</abbr> face, the <strong>query</strong> command:</p> 
<pre class=" code"><code><span class="java_plain">puppet&nbsp;help&nbsp;query</span>
<span class="java_plain">puppet&nbsp;query&nbsp;facts&nbsp;</span><span class="java_literal">'(osfamily=RedHat&nbsp;and&nbsp;operatingsystemversion=6)'</span><span class="java_plain"></span></code></pre> 
<h2>Functions</h2>
<p>The functions provided by the module can be used inside manifests to populate the catalog with data retrieved on PuppetDB.</p>
<p><strong>query_nodes</strong> takes 2 arguments: the query to use and (optional) the fact to return (by default it provides the certname). It returns an array:</p> 
<pre class=" code"><code><span class="java_plain">$webservers&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;query_nodes</span><span class="java_separator">(</span><span class="java_literal">'osfamily=Debian&nbsp;and&nbsp;Class[Apache]'</span><span class="java_separator">)</span><span class="java_plain"></span>
<span class="java_plain">$webserver_ip&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;query_nodes</span><span class="java_separator">(</span><span class="java_literal">'osfamily=Debian&nbsp;and&nbsp;Class[Apache]'</span><span class="java_separator">,</span><span class="java_plain">&nbsp;ipaddress</span><span class="java_separator">)</span><span class="java_plain"></span></code></pre>
<p><strong>query_facts</strong> requires 2 arguments: the query to use to discover nodes and the list of facts to return for them. It returns a nested hash in JSON format.</p> 
<pre class=" code"><code><span class="java_plain">query_facts</span><span class="java_separator">(</span><span class="java_literal">'Class[Apache]{port=443}'</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_separator">[</span><span class="java_literal">'osfamily'</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">'ipaddress'</span><span class="java_separator">])</span><span class="java_plain"></span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>MCollective - Overview</h2>
       
                            
     <h3>Essentials</h3> 
<h3>&nbsp;Installation and configuration</h3> 
<h3>The mco command</h3>
  </section>

  <section class="slide">
     
     
           
       
         <h2>MCollective essentials</h2>
       
                            
     <p>An orchestration framework that allows massively parallel actions on the infrastructure's server</p>
<p>Based on 3 components:</p>
<p>One or more central consoles, from where the <strong>mco</strong> command can be issued</p>
<p>The infrastructure nodes, where an <strong>agent</strong> receives and executes the requested actions</p>
<p>A middleware <strong>message broker</strong>, that allows communication between master(s) and agents</p>
<p>Possible actions are based on plugins<br />Common plugins are: <strong>service</strong>, <strong>package</strong>, <strong>puppetd</strong>, <strong>filemgr</strong>...</p>
<p>Simple RCPs allow easy definitions of new plugins or actions.</p>
<p>Security is handled at different layers: transport, authentication and authorization via different plugins. Here is a <a href="http://docs.puppetlabs.com/mcollective/security.html">Security Overview</a></p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Installation</h2>
       
                            
     <p>Some distros provide native mcollective packages but it's definitively recommended to use <a href="http://docs.puppetlabs.com/guides/puppetlabs_package_repositories.html">PuppetLabs repositories</a> to have recent mcollective versions and packages for the needed dependencies.</p>
<p>On the nodes to be managed just install the <strong>mcollective</strong> package, it's configuration file is <strong>/etc/mcollective/server.cfg</strong></p>
<p>On the administrative nodes, from where to control the infrastructure, install the <strong>mcollective-client</strong> package, it's configuration file is <strong>/etc/mcollective/client.cfg</strong></p>
<p>On both clients and servers we have to install the <a href="http://docs.puppetlabs.com/mcollective/deploy/plugins.html">agent plugins</a></p>
<p>On the middleware server(s) install <strong>activemq</strong> or <strong>rabbitmq</strong></p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Configuration</h2>
       
                            
     <p>Configuration files are similar for <a href="http://docs.puppetlabs.com/mcollective/configure/server.html">server</a> and <a href="http://docs.puppetlabs.com/mcollective/configure/client.html">client</a>.</p>
<p>They are in a typical setting = value format and # are used for comments.</p>
<p>We have to define to connetion settings to the middleware, the settings for the chosen security plugins, the facts source and other general settings.</p>
<p>The setup of the whole infrastructure involves some parameters to be consistent on the mcollective config files and the message broker ones (credentials and eventually certificates).</p>
<p>There can be different setups, according to the security plugins used, the recommended one is well described in the <a href="http://docs.puppetlabs.com/mcollective/deploy/standard.html">Standard Mcollective Deployment</a></p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Using the mco command</h2>
       
                            
     <p>The <strong>mco</strong> command is installed on the Mcollective clients and can be used to perform actions on any node of the infrastructure.</p>
<p>General usage:</p> 
<pre class=" code"><code><span class="java_plain">mco&nbsp;</span><span class="java_separator">[</span><span class="java_plain">subcommand</span><span class="java_separator">]</span><span class="java_plain">&nbsp;</span><span class="java_separator">[</span><span class="java_plain">options</span><span class="java_separator">]</span><span class="java_plain">&nbsp;</span><span class="java_separator">[</span><span class="java_plain">filters</span><span class="java_separator">]</span><span class="java_plain"></span>
<span class="java_plain">mco&nbsp;rpc&nbsp;</span><span class="java_separator">[</span><span class="java_plain">options</span><span class="java_separator">]</span><span class="java_plain">&nbsp;</span><span class="java_separator">[</span><span class="java_plain">filters</span><span class="java_separator">]</span><span class="java_plain">&nbsp;</span><span class="java_operator">&lt;</span><span class="java_plain">agent</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;</span><span class="java_operator">&lt;</span><span class="java_plain">action</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;</span><span class="java_separator">[</span><span class="java_operator">&lt;</span><span class="java_plain">key</span><span class="java_operator">=</span><span class="java_plain">val</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;</span><span class="java_operator">&lt;</span><span class="java_plain">key</span><span class="java_operator">=</span><span class="java_plain">val</span><span class="java_operator">&gt;</span><span class="java_separator">]</span><span class="java_plain"></span></code></pre>
<p>Most used subcommands are <strong>ping</strong> , <strong>rpc</strong> , <strong>inventory</strong>, <strong>find</strong></p>
<p>Most used options are: <strong>-batch SIZE</strong> (send requests in batches), <strong>-q</strong> (quiet), <strong>-j</strong> (produce Json output), <strong>-v</strong> (verbose)</p>
<p>Most used filters are: <strong>-F &lt;fact=val&gt;</strong> (Match hosts with the specified fact value), <strong>-I </strong> (Match host with the given name).</p>
<p>Sample commands:</p> 
<pre class=" code"><code><span class="java_plain">mco&nbsp;help</span>
<span class="java_plain">mco&nbsp;help&nbsp;rpc</span>
<span class="java_plain">mco&nbsp;ping</span>
<span class="java_plain">mco&nbsp;rpc&nbsp;service&nbsp;status&nbsp;service</span><span class="java_operator">=</span><span class="java_plain">mysqld</span>
<span class="java_plain">mco&nbsp;ping&nbsp;</span><span class="java_operator">-</span><span class="java_plain">F&nbsp;datacenter</span><span class="java_operator">=</span><span class="java_plain">eu</span><span class="java_operator">-</span><span class="java_literal">1</span><span class="java_plain"></span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Puppet reporting - Overview</h2>
       
                            
     <h3>Reporting overview</h3> 
<h3>Understanding puppet run output</h3>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Reporting</h2>
       
                            
     <p>In reports <abbr title="Puppet automation tool">Puppet</abbr> stores information of what has changed on the system after a <abbr title="Puppet automation tool">Puppet</abbr> run</p>
<p>Reports are sent from the client to the Master, if report is enabled</p> 
<pre class=" code"><code><span class="java_plain">#&nbsp;</span><span class="java_type">On</span><span class="java_plain">&nbsp;client</span><span class="java_literal">'s&nbsp;puppet.conf&nbsp;[agent]</span>
<span class="java_plain">report&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">true</span><span class="java_plain"></span></code></pre>
<p>On the Master different report processors may be enabled</p> 
<pre class=" code"><code><span class="java_plain">#&nbsp;</span><span class="java_type">On</span><span class="java_plain">&nbsp;server</span><span class="java_literal">'s&nbsp;puppet.conf&nbsp;[master]</span>
<span class="java_plain">reports&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;log</span><span class="java_separator">,</span><span class="java_plain">tagmail</span><span class="java_separator">,</span><span class="java_plain">store</span><span class="java_separator">,</span><span class="java_plain">https</span>
<span class="java_plain">reporturl&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;http</span><span class="java_operator">:</span><span class="java_comment">//localhost:3000/reports</span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Understanding Puppet runs output</h2>
       
                            
     <p><abbr title="Puppet automation tool">Puppet</abbr> is very informative about what it does on the functions</p> 
<pre class=" code"><code><span class="java_operator">/</span><span class="java_type">Stage</span><span class="java_separator">[</span><span class="java_plain">main</span><span class="java_separator">]</span><span class="java_operator">/</span><span class="java_type">Example42</span><span class="java_operator">::</span><span class="java_type">CommonSetup</span><span class="java_operator">/</span><span class="java_type">File</span><span class="java_separator">[</span><span class="java_operator">/</span><span class="java_plain">etc</span><span class="java_operator">/</span><span class="java_plain">motd</span><span class="java_separator">]</span><span class="java_operator">/</span><span class="java_plain">content</span><span class="java_operator">:</span><span class="java_plain"></span>
<span class="java_operator">---</span><span class="java_plain">&nbsp;</span><span class="java_operator">/</span><span class="java_plain">etc</span><span class="java_operator">/</span><span class="java_plain">motd&nbsp;&nbsp;&nbsp;</span><span class="java_literal">2012</span><span class="java_operator">-</span><span class="java_literal">12</span><span class="java_operator">-</span><span class="java_literal">13</span><span class="java_plain">&nbsp;</span><span class="java_literal">10</span><span class="java_operator">:</span><span class="java_literal">37</span><span class="java_operator">:</span><span class="java_literal">29.000000000</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_literal">0100</span><span class="java_plain"></span>
<span class="java_operator">+++</span><span class="java_plain">&nbsp;</span><span class="java_operator">/</span><span class="java_plain">tmp</span><span class="java_operator">/</span><span class="java_plain">puppet</span><span class="java_operator">-</span><span class="java_plain">file20121213</span><span class="java_operator">-</span><span class="java_literal">19295</span><span class="java_operator">-</span><span class="java_plain">qe4wv2</span><span class="java_operator">-</span><span class="java_literal">0</span><span class="java_plain">&nbsp;</span><span class="java_literal">2012</span><span class="java_operator">-</span><span class="java_literal">12</span><span class="java_operator">-</span><span class="java_literal">13</span><span class="java_plain">&nbsp;</span><span class="java_literal">10</span><span class="java_operator">:</span><span class="java_literal">38</span><span class="java_operator">:</span><span class="java_literal">19.000000000</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_literal">0100</span><span class="java_plain"></span>
<span class="java_plain">@@&nbsp;</span><span class="java_operator">-</span><span class="java_literal">4</span><span class="java_separator">,</span><span class="java_literal">4</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_literal">4</span><span class="java_separator">,</span><span class="java_literal">4</span><span class="java_plain">&nbsp;@@</span>
<span class="java_operator">-</span><span class="java_type">Last</span><span class="java_plain">&nbsp;</span><span class="java_type">Puppet</span><span class="java_plain">&nbsp;</span><span class="java_type">Run</span><span class="java_operator">:</span><span class="java_plain">&nbsp;</span><span class="java_type">Thu</span><span class="java_plain">&nbsp;</span><span class="java_type">Dec</span><span class="java_plain">&nbsp;</span><span class="java_literal">13</span><span class="java_plain">&nbsp;</span><span class="java_literal">10</span><span class="java_operator">:</span><span class="java_literal">36</span><span class="java_operator">:</span><span class="java_literal">58</span><span class="java_plain">&nbsp;CET&nbsp;</span><span class="java_literal">2012</span><span class="java_plain"></span>
<span class="java_operator">+</span><span class="java_type">Last</span><span class="java_plain">&nbsp;</span><span class="java_type">Puppet</span><span class="java_plain">&nbsp;</span><span class="java_type">Run</span><span class="java_operator">:</span><span class="java_plain">&nbsp;</span><span class="java_type">Thu</span><span class="java_plain">&nbsp;</span><span class="java_type">Dec</span><span class="java_plain">&nbsp;</span><span class="java_literal">13</span><span class="java_plain">&nbsp;</span><span class="java_literal">10</span><span class="java_operator">:</span><span class="java_literal">38</span><span class="java_operator">:</span><span class="java_literal">00</span><span class="java_plain">&nbsp;CET&nbsp;</span><span class="java_literal">2012</span><span class="java_plain"></span>
<span class="java_type">Info</span><span class="java_operator">:</span><span class="java_plain">&nbsp;</span><span class="java_operator">/</span><span class="java_type">Stage</span><span class="java_separator">[</span><span class="java_plain">main</span><span class="java_separator">]</span><span class="java_operator">/</span><span class="java_type">Example42</span><span class="java_operator">::</span><span class="java_type">CommonSetup</span><span class="java_operator">/</span><span class="java_type">File</span><span class="java_separator">[</span><span class="java_operator">/</span><span class="java_plain">etc</span><span class="java_operator">/</span><span class="java_plain">motd</span><span class="java_separator">]</span><span class="java_operator">:</span><span class="java_plain">&nbsp;</span><span class="java_type">Filebucketed</span><span class="java_plain">&nbsp;</span><span class="java_operator">/</span><span class="java_plain">etc</span><span class="java_operator">/</span><span class="java_plain">motd&nbsp;to&nbsp;main&nbsp;with&nbsp;sum&nbsp;</span><span class="java_literal">623</span><span class="java_plain">bcd5f8785251e2cd00a88438d6d08</span>
<span class="java_operator">/</span><span class="java_type">Stage</span><span class="java_separator">[</span><span class="java_plain">main</span><span class="java_separator">]</span><span class="java_operator">/</span><span class="java_type">Example42</span><span class="java_operator">::</span><span class="java_type">CommonSetup</span><span class="java_operator">/</span><span class="java_type">File</span><span class="java_separator">[</span><span class="java_operator">/</span><span class="java_plain">etc</span><span class="java_operator">/</span><span class="java_plain">motd</span><span class="java_separator">]</span><span class="java_operator">/</span><span class="java_plain">content</span><span class="java_operator">:</span><span class="java_plain">&nbsp;content&nbsp;changed&nbsp;</span><span class="java_literal">'{md5}623bcd5f8785251e2cd00a88438d6d08'</span><span class="java_plain">&nbsp;to&nbsp;</span><span class="java_literal">'{md5}91855575e2252c38ce01efedf1f48cd3'</span><span class="java_plain"></span></code></pre>
<p>The above lines refer to a change made by <abbr title="Puppet automation tool">Puppet</abbr> on /etc/motd<br /> The File[/etc/motd] resource is defined in the class example42::commonsetup<br /> A diff is shown of what has changed (the diff appears when running puppet agent -t in interactive mode)<br /> The original file has been filebucketed (saved) with checksum 623bcd5f8785251e2cd00a88438d6d08<br /> We can retrieve the original file in /var/lib/puppet/clientbucket/6/2/3/b/c/d/5/f/623bcd5f8785251e2cd00a88438d6d08/contents<br /> We can search for all the old versions of /etc/motd with</p> 
<pre class=" code"><code><span class="java_plain">grep&nbsp;</span><span class="java_operator">-</span><span class="java_plain">R&nbsp;</span><span class="java_literal">'/etc/motd'</span><span class="java_plain">&nbsp;</span><span class="java_operator">/</span><span class="java_plain">var</span><span class="java_operator">/</span><span class="java_plain">lib</span><span class="java_operator">/</span><span class="java_plain">puppet</span><span class="java_operator">/</span><span class="java_plain">clientbucket</span><span class="java_comment">/*</span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Developing Puppet extensions - Overview</h2>
       
                            
     <h3>Developing custom facts</h3> 
<h3>Developing custom types and provides</h3> 
<h3>Developing functions</h3>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Developing Facts</h2>
       
                            
     <p>Facts are generated on the client before the evaluation of the <abbr title="Puppet automation tool">Puppet</abbr> code on the server.</p>
<p>Facts provide variables that can be used in <abbr title="Puppet automation tool">Puppet</abbr> code and templates.</p>
<p>A simple custom type that just executes a shell command:</p> 
<pre class=" code"><code><span class="java_plain">require&nbsp;</span><span class="java_literal">'facter'</span><span class="java_plain"></span>
<span class="java_type">Facter</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_literal">&quot;last_run&quot;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_keyword">do</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;setcode&nbsp;</span><span class="java_keyword">do</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Facter</span><span class="java_operator">::</span><span class="java_type">Util</span><span class="java_operator">::</span><span class="java_type">Resolution</span><span class="java_separator">.</span><span class="java_plain">exec</span><span class="java_separator">(</span><span class="java_literal">'date'</span><span class="java_separator">)</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;end</span>
<span class="java_plain">end</span></code></pre>
<p>This file should be placed in /lib/facter/acpi_available.rb</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Developing Types</h2>
       
                            
     <p>Resource types can be defined in <abbr title="Puppet automation tool">Puppet</abbr> language or in Ruby as plugins.</p>
<p>Ruby types require one or more <strong>providers</strong> which manage low-lovel interaction with the underlining OS to provide the more abstact resource defined in Types.</p>
<p>An example of a type with many providers is package, which has more than 20 providers that manage packages on different OS.</p>
<p>A sample type structure (A type called vcsrepo, must have a path like <strong>/lib/puppet/type/vcsrepo.rb</strong></p> 
<pre class=" code"><code><span class="java_plain">require&nbsp;</span><span class="java_literal">'pathname'</span><span class="java_plain"></span>
<span class="java_plain"></span>
<span class="java_type">Puppet</span><span class="java_operator">::</span><span class="java_type">Type</span><span class="java_separator">.</span><span class="java_plain">newtype</span><span class="java_separator">(</span><span class="java_operator">:</span><span class="java_plain">vcsrepo</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_keyword">do</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;desc&nbsp;</span><span class="java_literal">&quot;A&nbsp;local&nbsp;version&nbsp;control&nbsp;repository&quot;</span><span class="java_plain"></span>
<span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;feature&nbsp;</span><span class="java_operator">:</span><span class="java_plain">gzip_compression</span><span class="java_separator">,</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">&quot;The&nbsp;provider&nbsp;supports&nbsp;explicit&nbsp;GZip&nbsp;compression&nbsp;levels&quot;</span><span class="java_plain"></span>
<span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">[...]</span><span class="java_plain">&nbsp;</span><span class="java_type">List</span><span class="java_plain">&nbsp;of&nbsp;the&nbsp;features</span>
<span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;ensurable&nbsp;</span><span class="java_keyword">do</span><span class="java_plain"></span>
<span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;newvalue&nbsp;</span><span class="java_operator">:</span><span class="java_plain">present&nbsp;</span><span class="java_keyword">do</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;provider</span><span class="java_separator">.</span><span class="java_plain">create</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;end</span>
<span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">[...]</span><span class="java_plain">&nbsp;</span><span class="java_type">List</span><span class="java_plain">&nbsp;of&nbsp;the&nbsp;accepted&nbsp;values</span>
<span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;newparam</span><span class="java_separator">(</span><span class="java_operator">:</span><span class="java_plain">source</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_keyword">do</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;desc&nbsp;</span><span class="java_literal">&quot;The&nbsp;source&nbsp;URI&nbsp;for&nbsp;the&nbsp;repository&quot;</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;end</span>
<span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">[...]</span><span class="java_plain">&nbsp;</span><span class="java_type">List</span><span class="java_plain">&nbsp;of&nbsp;the&nbsp;accepted&nbsp;parameters</span>
<span class="java_plain"></span>
<span class="java_plain">end</span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Developing Providers</h2>
       
                            
     <p>The vcsrepo type seen before has 5 different providers for different source control tools.</p>
<p>Here is, as an example, the git provider for the vcsrepo type (Code (C) by PuppetLabs):<br /> This file should be placed <strong>/lib/puppet/provider/vcsrepo/git.rb</strong></p> 
<pre class=" code"><code><span class="java_plain">require&nbsp;</span><span class="java_type">File</span><span class="java_separator">.</span><span class="java_plain">join</span><span class="java_separator">(</span><span class="java_type">File</span><span class="java_separator">.</span><span class="java_plain">dirname</span><span class="java_separator">(</span><span class="java_plain">__FILE__</span><span class="java_separator">),</span><span class="java_plain">&nbsp;</span><span class="java_literal">'..'</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">'vcsrepo'</span><span class="java_separator">)</span><span class="java_plain"></span>
<span class="java_plain"></span>
<span class="java_type">Puppet</span><span class="java_operator">::</span><span class="java_type">Type</span><span class="java_separator">.</span><span class="java_plain">type</span><span class="java_separator">(</span><span class="java_operator">:</span><span class="java_plain">vcsrepo</span><span class="java_separator">).</span><span class="java_plain">provide</span><span class="java_separator">(</span><span class="java_operator">:</span><span class="java_plain">git</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_operator">:</span><span class="java_plain">parent&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_type">Puppet</span><span class="java_operator">::</span><span class="java_type">Provider</span><span class="java_operator">::</span><span class="java_type">Vcsrepo</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_keyword">do</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;desc&nbsp;</span><span class="java_literal">&quot;Supports&nbsp;Git&nbsp;repositories&quot;</span><span class="java_plain"></span>
<span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;commands&nbsp;</span><span class="java_operator">:</span><span class="java_plain">git&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">'git'</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;defaultfor&nbsp;</span><span class="java_operator">:</span><span class="java_plain">git&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_operator">:</span><span class="java_plain">exists</span>
<span class="java_plain">&nbsp;&nbsp;has_features&nbsp;</span><span class="java_operator">:</span><span class="java_plain">bare_repositories</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_operator">:</span><span class="java_plain">reference_tracking</span>
<span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;def&nbsp;create</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_operator">!</span><span class="java_plain">@resource</span><span class="java_separator">.</span><span class="java_plain">value</span><span class="java_separator">(</span><span class="java_operator">:</span><span class="java_plain">source</span><span class="java_separator">)</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;init_repository</span><span class="java_separator">(</span><span class="java_plain">@resource</span><span class="java_separator">.</span><span class="java_plain">value</span><span class="java_separator">(</span><span class="java_operator">:</span><span class="java_plain">path</span><span class="java_separator">))</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">else</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clone_repository</span><span class="java_separator">(</span><span class="java_plain">@resource</span><span class="java_separator">.</span><span class="java_plain">value</span><span class="java_separator">(</span><span class="java_operator">:</span><span class="java_plain">source</span><span class="java_separator">),</span><span class="java_plain">&nbsp;@resource</span><span class="java_separator">.</span><span class="java_plain">value</span><span class="java_separator">(</span><span class="java_operator">:</span><span class="java_plain">path</span><span class="java_separator">))</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;@resource</span><span class="java_separator">.</span><span class="java_plain">value</span><span class="java_separator">(</span><span class="java_operator">:</span><span class="java_plain">revision</span><span class="java_separator">)</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;@resource</span><span class="java_separator">.</span><span class="java_plain">value</span><span class="java_separator">(</span><span class="java_operator">:</span><span class="java_plain">ensure</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_operator">==</span><span class="java_plain">&nbsp;</span><span class="java_operator">:</span><span class="java_plain">bare</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;notice&nbsp;</span><span class="java_literal">&quot;Ignoring&nbsp;revision&nbsp;for&nbsp;bare&nbsp;repository&quot;</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">else</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;checkout_branch_or_reset</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;@resource</span><span class="java_separator">.</span><span class="java_plain">value</span><span class="java_separator">(</span><span class="java_operator">:</span><span class="java_plain">ensure</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_operator">!=</span><span class="java_plain">&nbsp;</span><span class="java_operator">:</span><span class="java_plain">bare</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;update_submodules</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;end</span>
<span class="java_plain">&nbsp;&nbsp;end</span>
<span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;def&nbsp;destroy</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">FileUtils</span><span class="java_separator">.</span><span class="java_plain">rm_rf</span><span class="java_separator">(</span><span class="java_plain">@resource</span><span class="java_separator">.</span><span class="java_plain">value</span><span class="java_separator">(</span><span class="java_operator">:</span><span class="java_plain">path</span><span class="java_separator">))</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;end</span>
<span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">[...]</span><span class="java_plain"></span>
<span class="java_plain"></span>
<span class="java_plain">end</span></code></pre>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Developing Functions</h2>
       
                            
     <p>Functions are Ruby code that is executed during compilation on the <abbr title="Puppet automation tool">Puppet</abbr> Master.</p>
<p>They are used to interface with external tools, provide debugging or interpolate strings.</p>
<p>Importants parts of the <abbr title="Puppet automation tool">Puppet</abbr> language like include and template are implemented as functions.</p> 
<pre class=" code"><code><span class="java_plain">module&nbsp;</span><span class="java_type">Puppet</span><span class="java_operator">::</span><span class="java_type">Parser</span><span class="java_operator">::</span><span class="java_type">Functions</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;newfunction</span><span class="java_separator">(</span><span class="java_operator">:</span><span class="java_plain">get_magicvar</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_operator">:</span><span class="java_plain">type&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_operator">:</span><span class="java_plain">rvalue</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_operator">:</span><span class="java_plain">doc&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_operator">&lt;&lt;-</span><span class="java_plain">EOS</span>
<span class="java_type">This</span><span class="java_plain">&nbsp;returns&nbsp;the&nbsp;value&nbsp;of&nbsp;the&nbsp;input&nbsp;variable</span><span class="java_separator">.</span><span class="java_plain">&nbsp;</span><span class="java_type">For</span><span class="java_plain">&nbsp;example&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;you&nbsp;input&nbsp;role</span>
<span class="java_plain">it&nbsp;returns&nbsp;the&nbsp;value&nbsp;of&nbsp;$role</span><span class="java_literal">'.</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;EOS</span>
<span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_keyword">do</span><span class="java_plain">&nbsp;</span><span class="java_operator">|</span><span class="java_plain">arguments</span><span class="java_operator">|</span><span class="java_plain"></span>
<span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;raise</span><span class="java_separator">(</span><span class="java_type">Puppet</span><span class="java_operator">::</span><span class="java_type">ParseError</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;get_magicvar():&nbsp;Wrong&nbsp;number&nbsp;of&nbsp;arguments&nbsp;&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">&quot;given&nbsp;(#{arguments.size}&nbsp;for&nbsp;1)&quot;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;arguments</span><span class="java_separator">.</span><span class="java_plain">size&nbsp;</span><span class="java_operator">&lt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">1</span><span class="java_plain"></span>
<span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;my_var&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;arguments</span><span class="java_separator">[</span><span class="java_literal">0</span><span class="java_separator">]</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;lookupvar</span><span class="java_separator">(</span><span class="java_literal">&quot;#{my_var}&quot;</span><span class="java_separator">)</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">'all'</span><span class="java_plain">&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;result&nbsp;</span><span class="java_operator">==</span><span class="java_plain">&nbsp;</span><span class="java_operator">:</span><span class="java_plain">undefined&nbsp;</span><span class="java_operator">||</span><span class="java_plain">&nbsp;result&nbsp;</span><span class="java_operator">==</span><span class="java_plain">&nbsp;</span><span class="java_literal">''</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain"></span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;result</span>
<span class="java_plain">&nbsp;&nbsp;end</span>
<span class="java_plain">end</span></code></pre>
<p>This file is placed in puppi/lib/puppet/parser/functions/get_magicvar.rb.</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Scaling Puppet</h2>
       
                            
     <h3>Optimizing code for performance</h3>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Optimize code for performance</h2>
       
                            
     <p>Reduce the number of resources per node<br /> For each resource <abbr title="Puppet automation tool">Puppet</abbr> has to serialize, deserialize, apply, report...<br /> Avoid use of resources for too many entities (Do manage hundreds of users with the User type)<br /> Limit overhead of containing classes<br /> (A module with the openssh::package, openssh::service, openssh::configuration subclasses pattern is uselessly filled with extra resources)</p>
<p>Do not use the file type to deliver too large files or binaries:<br /> For each file <abbr title="Puppet automation tool">Puppet</abbr> has to make a checksum to verify if it has changed<br /> With source =&gt; , the content of the file is retrieved with a new connection to the PuppetMaster<br /> With content =&gt; template() , the content is placed inside the catalog.<br /> Avoid too many elements in a source array for file retrieval:</p> 
<pre class=" code"><code><span class="java_plain">source&nbsp;</span><span class="java_operator">=&gt;</span><span class="java_plain">&nbsp;</span><span class="java_separator">[</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;site/openssh/sshd.conf---$::hostname&nbsp;,</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">&quot;site/openssh/sshd.conf--$environemnt-$role&nbsp;,</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">&quot;site/openssh/sshd.conf-$role&nbsp;,</span>
<span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">&quot;site/openssh/sshd.conf&nbsp;],</span></code></pre>
<p>This checks 3 files (and eventually gets 3 404 errors from server) before getting the default ones.</p>
  </section>

  <section class="slide">
     
     
           
       
         <h2>Reduce PuppetMaster(s) load</h2>
       
                            
     <p>Run <abbr title="Puppet automation tool">Puppet</abbr> less frequently (default 30 mins)</p>
<p>Evaluate centrally managed, on-demand, <abbr title="Puppet automation tool">Puppet</abbr> Runs (ie: via MCollective)</p>
<p>Evaluate Master-less setups</p>
<p>Use a <a href="http://docs.puppetlabs.com/guides/passenger.html">setup with Passenger</a> to have multiple PuppetMasters childs on different CPUs</p>
<p>Disable Store Configs if not used</p> 
<pre class=" code"><code><span class="java_plain">storeconfigs&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">false</span><span class="java_plain"></span></code></pre>
<p>Alternatively enable Thin Store Configs and Mysql backend</p> 
<pre class=" code"><code><span class="java_plain">storeconfigs&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">true</span><span class="java_plain"></span>
<span class="java_plain">thin_storeconfigs&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">true</span><span class="java_plain"></span>
<span class="java_plain">dbadapter&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;mysql</span>
<span class="java_plain">dbname&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;puppet</span>
<span class="java_plain">dbserver&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;mysql</span><span class="java_separator">.</span><span class="java_plain">example42</span><span class="java_separator">.</span><span class="java_plain">com</span>
<span class="java_plain">dbuser&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;puppet</span>
<span class="java_plain">dbpassword&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_operator">&lt;%=</span><span class="java_plain">&nbsp;scope</span><span class="java_separator">.</span><span class="java_plain">lookupvar</span><span class="java_separator">(</span><span class="java_literal">'secret::puppet_db_password'</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_operator">%&gt;</span><span class="java_plain"></span></code></pre>
<p>Evaluate PuppetDB as backend (faster)</p> 
<pre class=" code"><code><span class="java_plain">storeconfigs&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">true</span><span class="java_plain"></span>
<span class="java_plain">storeconfigs_backend&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;puppetdb</span></code></pre>
  </section>


<!-- End slides. -->


<!-- Begin extension snippets. Add or remove as needed. -->

<!-- deck.navigation snippet -->
<a href="#" class="deck-prev-link" title="Previous">&#8592;</a>
<a href="#" class="deck-next-link" title="Next">&#8594;</a>

<!-- deck.logo snippet -->


<!-- deck.status snippet -->
<p class="deck-status">
	<span class="deck-status-current"></span>
	/
	<span class="deck-status-total"></span>
</p>

<!-- deck.goto snippet -->
<form action="." method="get" class="goto-form">
	<label for="goto-slide">Go to slide:</label>
	<input type="text" name="slidenum" id="goto-slide" list="goto-datalist">
	<datalist id="goto-datalist"></datalist>
	<input type="submit" value="Go">
</form>

<!-- deck.hash snippet -->
<a href="." title="Permalink to this slide" class="deck-permalink">#</a>

<!-- End extension snippets. -->


<!-- Required JS files. -->
<script src="jquery-1.12.4.min.js"></script>
<script src="core/deck.core.js"></script>

<!-- Extension JS files. Add or remove as needed. -->
<script src="extensions/hash/deck.hash.js"></script>
<script src="extensions/menu/deck.menu.js"></script>
<script src="extensions/goto/deck.goto.js"></script>
<script src="extensions/status/deck.status.js"></script>
<script src="extensions/navigation/deck.navigation.js"></script>
<script src="extensions/scale/deck.scale.js"></script>

<!-- Initialize the deck. You can put this in an external file if desired. -->
<script>
	$(function() {
		$.deck('.slide');
	});
	
</script>
</body>
</html>
